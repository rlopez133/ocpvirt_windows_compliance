---
# WinRM Authentication Migration Playbook
# Safely disables Basic authentication after operator has switched to NTLM
#
# PREREQUISITES:
#   1. Update your inventory to use: ansible_winrm_transport: ntlm
#   2. Verify connectivity with: ansible -m win_ping <host>
#   3. Then run this playbook
#
# This playbook addresses:
#   - V-205711 (WN19-CC-000470): WinRM client must not use Basic authentication
#   - V-205713 (WN19-CC-000500): WinRM service must not use Basic authentication
#
# WARNING: Do NOT run this from AAP if your inventory still uses basic auth transport!

- name: WinRM Authentication Migration
  hosts: all
  gather_facts: false

  vars:
    # Force check - set to true to bypass transport check (dangerous!)
    force_migration: false

  pre_tasks:
    - name: Gather minimal facts for connection info
      ansible.builtin.setup:
        gather_subset:
          - "!all"
          - "!min"

    - name: Detect current Ansible WinRM transport
      ansible.builtin.set_fact:
        current_transport: "{{ ansible_winrm_transport | default('basic') | lower }}"

    - name: Display current transport configuration
      ansible.builtin.debug:
        msg: |
          WinRM Authentication Migration
          ===============================
          Target: {{ inventory_hostname }}
          Current Transport: {{ current_transport }}
          Force Migration: {{ force_migration }}

    - name: FAIL if transport is Basic (safety check)
      when:
        - current_transport == 'basic'
        - not force_migration
      ansible.builtin.fail:
        msg: |
          SAFETY CHECK FAILED: Ansible is configured to use Basic authentication.

          Running this playbook with Basic auth will disconnect you when WinRM restarts!

          To fix this:
          1. Update your inventory to use NTLM:
             ansible_winrm_transport: ntlm

          2. Verify connectivity works with NTLM:
             ansible -m win_ping {{ inventory_hostname }}

          3. Then run this playbook again.

          If you understand the risks and want to proceed anyway (NOT RECOMMENDED),
          run with: -e force_migration=true

    - name: Warn if force_migration is enabled
      when: force_migration
      ansible.builtin.debug:
        msg: |
          WARNING: force_migration is enabled!
          Proceeding despite transport being: {{ current_transport }}
          YOU MAY LOSE CONNECTIVITY TO THIS VM!

  tasks:
    # =========================================================================
    # Step 1: Verify current WinRM configuration
    # =========================================================================
    - name: Get current WinRM authentication configuration
      ansible.windows.win_shell: |
        $config = @{
            ClientAllowBasic = (Get-Item WSMan:\localhost\Client\Auth\Basic -ErrorAction SilentlyContinue).Value
            ServiceAllowBasic = (Get-Item WSMan:\localhost\Service\Auth\Basic -ErrorAction SilentlyContinue).Value
            ClientAllowNTLM = (Get-Item WSMan:\localhost\Client\Auth\Negotiate -ErrorAction SilentlyContinue).Value
            ServiceAllowNTLM = (Get-Item WSMan:\localhost\Service\Auth\Negotiate -ErrorAction SilentlyContinue).Value
        }
        $config | ConvertTo-Json -Compress
      register: winrm_config_raw
      changed_when: false

    - name: Parse WinRM configuration
      ansible.builtin.set_fact:
        winrm_config: "{{ winrm_config_raw.stdout | from_json }}"

    - name: Display current WinRM auth status
      ansible.builtin.debug:
        msg: |
          Current WinRM Authentication Status:
          - Client Basic Auth: {{ winrm_config.ClientAllowBasic | default('Not Set') }}
          - Service Basic Auth: {{ winrm_config.ServiceAllowBasic | default('Not Set') }}
          - Client NTLM/Negotiate: {{ winrm_config.ClientAllowNTLM | default('Not Set') }}
          - Service NTLM/Negotiate: {{ winrm_config.ServiceAllowNTLM | default('Not Set') }}

    # =========================================================================
    # Step 2: Ensure NTLM/Negotiate is enabled before disabling Basic
    # =========================================================================
    - name: Ensure NTLM/Negotiate authentication is enabled on WinRM Service
      ansible.windows.win_shell: |
        Set-Item WSMan:\localhost\Service\Auth\Negotiate -Value $true
        Set-Item WSMan:\localhost\Service\Auth\Kerberos -Value $true
      register: enable_ntlm_service

    - name: Ensure NTLM/Negotiate authentication is enabled on WinRM Client
      ansible.windows.win_shell: |
        Set-Item WSMan:\localhost\Client\Auth\Negotiate -Value $true
        Set-Item WSMan:\localhost\Client\Auth\Kerberos -Value $true
      register: enable_ntlm_client

    # =========================================================================
    # Step 3: Disable Basic authentication (V-205711, V-205713)
    # =========================================================================
    - name: Disable Basic authentication on WinRM Client (V-205711)
      ansible.windows.win_regedit:
        path: "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Client"
        name: "AllowBasic"
        data: 0
        type: dword
      register: disable_basic_client

    - name: Disable Basic authentication on WinRM Service (V-205713)
      ansible.windows.win_regedit:
        path: "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Service"
        name: "AllowBasic"
        data: 0
        type: dword
      register: disable_basic_service

    # =========================================================================
    # Step 4: Restart WinRM to apply changes
    # Use async "fire and forget" restart to avoid connection drop issues
    # =========================================================================
    - name: Restart WinRM service asynchronously (fire and forget)
      ansible.windows.win_shell: |
        # Schedule WinRM restart after a 2-second delay to allow this command to complete
        Start-Process powershell -ArgumentList '-Command', 'Start-Sleep -Seconds 2; Restart-Service WinRM -Force' -WindowStyle Hidden
      when: disable_basic_client.changed or disable_basic_service.changed
      async: 10
      poll: 0
      register: restart_async

    - name: Wait for WinRM to restart and reconnect
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 120
        sleep: 5
      when: disable_basic_client.changed or disable_basic_service.changed

    # =========================================================================
    # Step 5: Verify final configuration
    # =========================================================================
    - name: Verify final WinRM configuration
      ansible.windows.win_shell: |
        $config = @{
            ClientAllowBasic = (Get-Item WSMan:\localhost\Client\Auth\Basic -ErrorAction SilentlyContinue).Value
            ServiceAllowBasic = (Get-Item WSMan:\localhost\Service\Auth\Basic -ErrorAction SilentlyContinue).Value
            ClientAllowNTLM = (Get-Item WSMan:\localhost\Client\Auth\Negotiate -ErrorAction SilentlyContinue).Value
            ServiceAllowNTLM = (Get-Item WSMan:\localhost\Service\Auth\Negotiate -ErrorAction SilentlyContinue).Value
        }
        $config | ConvertTo-Json -Compress
      register: winrm_final_config
      changed_when: false

    - name: Parse final WinRM configuration
      ansible.builtin.set_fact:
        winrm_final: "{{ winrm_final_config.stdout | from_json }}"

    - name: Display migration result
      ansible.builtin.debug:
        msg: |
          WinRM Migration Complete
          ========================
          Final Authentication Status:
          - Client Basic Auth: {{ winrm_final.ClientAllowBasic }} (should be false)
          - Service Basic Auth: {{ winrm_final.ServiceAllowBasic }} (should be false)
          - Client NTLM/Negotiate: {{ winrm_final.ClientAllowNTLM }} (should be true)
          - Service NTLM/Negotiate: {{ winrm_final.ServiceAllowNTLM }} (should be true)

          STIG Controls Remediated:
          - V-205711 (WN19-CC-000470): WinRM Client Basic Auth Disabled
          - V-205713 (WN19-CC-000500): WinRM Service Basic Auth Disabled

          Run a compliance scan to verify remediation.
