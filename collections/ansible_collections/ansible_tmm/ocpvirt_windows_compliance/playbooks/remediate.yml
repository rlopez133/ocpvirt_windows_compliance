---
# Remediate Playbook
# Scan-driven remediation for Windows VMs (CAT I, CAT II, CAT III)
#
# This playbook should be run as an AAP Job Template against Windows VMs.
# Use limit/filter to target specific VMs.
#
# Supports two modes:
# 1. Scan-driven: Pass failed_cat1_controls from scan results
#    Example: failed_cat1_controls: "{{ scan_result.failed_controls.cat1 }}"
# 2. EDA-triggered: Receives category and failed_control_ids from AlertManager webhook
#    Example: trigger_source: "eda", category: "CAT2", failed_control_ids: ["V-205629"]

- name: Apply Scan-Driven Compliance Remediation
  hosts: all
  gather_facts: true
  collections:
    - infra.windows_ops
    - ansible_tmm.ocpvirt_windows_compliance

  vars:
    compliance_profile: "stig"
    # Pass failed control V-IDs from scan results
    # Example: ["V-205711", "V-205713", "V-205919"]
    failed_cat1_controls: []
    allow_reboot: false
    dry_run: false
    trigger_source: "manual"

  pre_tasks:
    - name: Debug - List installed collections
      delegate_to: localhost
      ansible.builtin.shell: |
        echo "=== Ansible Galaxy Collections ==="
        ansible-galaxy collection list
        echo ""
        echo "=== Collections Paths ==="
        ansible-config dump | grep -i collection
      register: collections_debug
      changed_when: false

    - name: Display installed collections
      ansible.builtin.debug:
        msg: "{{ collections_debug.stdout_lines }}"

    - name: Verify Windows target
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Windows"
        fail_msg: "This playbook only runs on Windows systems"

  roles:
    - role: ../roles/remediate

  post_tasks:
    # Build summary from scan_driven_result (set by scan_driven_*_remediation.yml tasks)
    - name: Compute totals from scan-driven results
      ansible.builtin.set_fact:
        total_changes: >-
          {{ (scan_driven_result.changes_applied.registry | default(0) | int) +
             (scan_driven_result.changes_applied.security_policy | default(0) | int) +
             (scan_driven_result.changes_applied.audit_policy | default(0) | int) +
             (scan_driven_result.changes_applied.user_rights | default(0) | int) +
             (scan_driven_result.changes_applied.firewall | default(0) | int) }}
        total_remediated: "{{ scan_driven_result.controls_remediated | default([]) | length }}"
        total_manual: "{{ scan_driven_result.controls_manual | default([]) | length }}"
        total_skipped: "{{ scan_driven_result.controls_skipped | default([]) | length }}"

    - name: Display final remediation summary
      ansible.builtin.debug:
        msg: |
          ================================================================================
                              REMEDIATION RESULTS
          ================================================================================

          Target:     {{ inventory_hostname }}
          OS:         Windows Server {{ remediation_result.os_version | default('Unknown') }}
          Mode:       {{ remediation_result.mode | default('unknown') }}
          Category:   {{ scan_driven_result.category | default(remediation_result.category) | default('N/A') }}

          Dry Run:    {{ remediation_result.dry_run | default(dry_run) }}
          Started:    {{ remediation_result.started | default('N/A') }}
          Completed:  {{ remediation_result.completed | default('N/A') }}

          --------------------------------------------------------------------------------
                              SCAN-DRIVEN REMEDIATION SUMMARY
          --------------------------------------------------------------------------------

          Controls Analyzed:    {{ scan_driven_result.controls_analyzed | default(0) }}
          Controls Remediated:  {{ total_remediated }} (automatable controls in map)
          Controls Manual:      {{ total_manual }} (require manual intervention)
          Controls Skipped:     {{ total_skipped }} (V-IDs not in remediation map)

          --------------------------------------------------------------------------------
                              CHANGES APPLIED
          --------------------------------------------------------------------------------

          Registry:        {{ scan_driven_result.changes_applied.registry | default(0) }}
          Security Policy: {{ scan_driven_result.changes_applied.security_policy | default(0) }}
          Audit Policy:    {{ scan_driven_result.changes_applied.audit_policy | default(0) }}
          User Rights:     {{ scan_driven_result.changes_applied.user_rights | default(0) }}
          Firewall:        {{ scan_driven_result.changes_applied.firewall | default(0) }}
          ------------------------------------
          TOTAL CHANGES:   {{ total_changes }}

          {% if total_manual | int > 0 %}
          Manual Controls (require human review):
          {% for v_id in scan_driven_result.controls_manual | default([]) %}  - {{ v_id }}
          {% endfor %}
          {% endif %}

          {% if total_skipped | int > 0 %}
          Skipped V-IDs (not in remediation map):
          {% for v_id in scan_driven_result.controls_skipped | default([]) %}  - {{ v_id }}
          {% endfor %}
          {% endif %}

          {% if total_changes | int == 0 %}
          No changes applied - controls may already be compliant or require manual action.
          {% endif %}

          Run a compliance scan to verify final compliance state.
          ================================================================================
