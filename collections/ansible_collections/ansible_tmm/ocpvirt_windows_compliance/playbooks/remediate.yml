---
# Remediate Playbook
# Scan-driven CAT I remediation for Windows VMs
#
# This playbook should be run as an AAP Job Template against Windows VMs.
# Use limit/filter to target specific VMs.
#
# Pass failed_cat1_controls from scan results to remediate only failed controls.
# Example usage (in AAP workflow):
#   failed_cat1_controls: "{{ scan_result.failed_controls.cat1 }}"

- name: Apply Scan-Driven CAT I Remediation
  hosts: all
  gather_facts: true

  vars:
    compliance_profile: "stig"
    # Pass failed control V-IDs from scan results
    # Example: ["V-205711", "V-205713", "V-205919"]
    failed_cat1_controls: []
    allow_reboot: false
    dry_run: false
    trigger_source: "manual"

  pre_tasks:
    - name: Verify Windows target
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Windows"
        fail_msg: "This playbook only runs on Windows systems"

    - name: Initialize result tracking variables
      ansible.builtin.set_fact:
        cat1_results: []
        cat2_results: []
        cat3_results: []

  roles:
    - role: ../roles/remediate

  post_tasks:
    # Compute category summaries from results
    - name: Compute category summaries
      ansible.builtin.set_fact:
        cat1_summary:
          found: "{{ cat1_results | default([]) | length }}"
          changed: "{{ cat1_results | default([]) | selectattr('status', 'eq', 'changed') | list | length }}"
          already_ok: "{{ cat1_results | default([]) | selectattr('status', 'eq', 'ok') | list | length }}"
          failed: "{{ cat1_results | default([]) | selectattr('status', 'eq', 'failed') | list | length }}"
          skipped: "{{ cat1_results | default([]) | selectattr('status', 'eq', 'skipped') | list | length }}"
        cat2_summary:
          found: "{{ cat2_results | default([]) | length }}"
          changed: "{{ cat2_results | default([]) | selectattr('status', 'eq', 'changed') | list | length }}"
          already_ok: "{{ cat2_results | default([]) | selectattr('status', 'eq', 'ok') | list | length }}"
          failed: "{{ cat2_results | default([]) | selectattr('status', 'eq', 'failed') | list | length }}"
          skipped: "{{ cat2_results | default([]) | selectattr('status', 'eq', 'skipped') | list | length }}"
        cat3_summary:
          found: "{{ cat3_results | default([]) | length }}"
          changed: "{{ cat3_results | default([]) | selectattr('status', 'eq', 'changed') | list | length }}"
          already_ok: "{{ cat3_results | default([]) | selectattr('status', 'eq', 'ok') | list | length }}"
          failed: "{{ cat3_results | default([]) | selectattr('status', 'eq', 'failed') | list | length }}"
          skipped: "{{ cat3_results | default([]) | selectattr('status', 'eq', 'skipped') | list | length }}"

    - name: Compute totals
      ansible.builtin.set_fact:
        total_summary:
          found: "{{ (cat1_summary.found | int) + (cat2_summary.found | int) + (cat3_summary.found | int) }}"
          changed: "{{ (cat1_summary.changed | int) + (cat2_summary.changed | int) + (cat3_summary.changed | int) }}"
          already_ok: "{{ (cat1_summary.already_ok | int) + (cat2_summary.already_ok | int) + (cat3_summary.already_ok | int) }}"
          failed: "{{ (cat1_summary.failed | int) + (cat2_summary.failed | int) + (cat3_summary.failed | int) }}"

    - name: Display final remediation summary
      ansible.builtin.debug:
        msg: |
          ================================================================================
                              REMEDIATION RESULTS
          ================================================================================

          Target:     {{ inventory_hostname }}
          OS:         Windows Server {{ remediation_result.os_version | default('Unknown') }}
          Mode:       {{ remediation_result.mode | default('unknown') }}
          {% if remediation_result.mode | default('') == 'eda' %}Category:   {{ remediation_result.category | default('N/A') }} only{% endif %}

          Dry Run:    {{ remediation_result.dry_run | default(dry_run) }}
          Started:    {{ remediation_result.started | default('N/A') }}
          Completed:  {{ remediation_result.completed | default('N/A') }}

          --------------------------------------------------------------------------------
                              RESULTS BY CATEGORY
          --------------------------------------------------------------------------------

          Category   | Found | Changed | Already OK | Failed
          -----------|-------|---------|------------|-------
          {% if (cat1_summary.found | int) > 0 or remediation_result.mode | default('') != 'eda' or remediation_result.category | default('') == 'CAT1' %}CAT I      | {{ '%5s' | format(cat1_summary.found) }} | {{ '%7s' | format(cat1_summary.changed) }} | {{ '%10s' | format(cat1_summary.already_ok) }} | {{ '%6s' | format(cat1_summary.failed) }}
          {% endif %}
          {% if (cat2_summary.found | int) > 0 or remediation_result.mode | default('') != 'eda' or remediation_result.category | default('') == 'CAT2' %}CAT II     | {{ '%5s' | format(cat2_summary.found) }} | {{ '%7s' | format(cat2_summary.changed) }} | {{ '%10s' | format(cat2_summary.already_ok) }} | {{ '%6s' | format(cat2_summary.failed) }}
          {% endif %}
          {% if (cat3_summary.found | int) > 0 or remediation_result.mode | default('') != 'eda' or remediation_result.category | default('') == 'CAT3' %}CAT III    | {{ '%5s' | format(cat3_summary.found) }} | {{ '%7s' | format(cat3_summary.changed) }} | {{ '%10s' | format(cat3_summary.already_ok) }} | {{ '%6s' | format(cat3_summary.failed) }}
          {% endif %}
          -----------|-------|---------|------------|-------
          TOTAL      | {{ '%5s' | format(total_summary.found) }} | {{ '%7s' | format(total_summary.changed) }} | {{ '%10s' | format(total_summary.already_ok) }} | {{ '%6s' | format(total_summary.failed) }}

          {% if (total_summary.changed | int) == 0 and (total_summary.failed | int) == 0 %}
          All controls already compliant - no changes needed.
          {% endif %}
          {% if (total_summary.failed | int) > 0 %}
          WARNING: {{ total_summary.failed }} control(s) failed remediation. Manual review required.
          {% endif %}

          Run a compliance scan to verify final compliance state.
          ================================================================================
