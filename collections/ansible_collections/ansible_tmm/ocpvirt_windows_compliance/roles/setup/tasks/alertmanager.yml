---
# Setup Role - Alertmanager Configuration
# Configures Alertmanager webhook receiver for EDA integration
# Requires eda.yml to run first to set eda_webhook_url and eda_generated_token facts
#
# Task order:
# 1. Deploy bearer token secret (US3)
# 2. Deploy AlertmanagerConfig with auth (US3)
# 3. Display configuration status (US3)

# =============================================================================
# Phase 5: User Story 3 - Alertmanager Bearer Token Configuration
# =============================================================================

- name: Skip Alertmanager configuration if EDA not enabled
  ansible.builtin.debug:
    msg: "Skipping Alertmanager webhook configuration - EDA is not enabled"
  when: not (eda_enabled | default(true))

- name: Deploy EDA bearer token secret
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('ansible.builtin.template', 'eda-token-secret.yml.j2') | from_yaml }}"
  when: eda_enabled | default(true)
  register: eda_token_secret_result

- name: Deploy AlertmanagerConfig for EDA webhook with bearer token auth
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1beta1
      kind: AlertmanagerConfig
      metadata:
        name: compliance-webhook
        namespace: "{{ tenant_config.namespace }}"
        labels: "{{ compliance_labels }}"
      spec:
        route:
          groupBy:
            - alertname
            - vm_name
            - namespace
          groupWait: 30s
          groupInterval: 5m
          repeatInterval: 4h
          receiver: eda-webhook
          routes:
            # CAT I alerts - notify immediately, no auto-remediation
            - matchers:
                - name: category
                  value: CAT1
                  matchType: "="
              receiver: eda-webhook-cat1
              groupWait: 10s
              repeatInterval: 1h

            # CAT II alerts - auto-remediation eligible
            - matchers:
                - name: category
                  value: CAT2
                  matchType: "="
              receiver: eda-webhook
              groupWait: 30s

            # CAT III alerts - lower priority
            - matchers:
                - name: category
                  value: CAT3
                  matchType: "="
              receiver: eda-webhook
              groupWait: 5m
              repeatInterval: 12h

        receivers:
          - name: eda-webhook
            webhookConfigs:
              - url: "{{ eda_webhook_url }}"
                sendResolved: true
                httpConfig:
                  followRedirects: true
                  authorization:
                    type: Bearer
                    credentials:
                      name: "{{ eda_token_secret_name }}"
                      key: token

          - name: eda-webhook-cat1
            webhookConfigs:
              - url: "{{ eda_webhook_url }}"
                sendResolved: true
                httpConfig:
                  followRedirects: true
                  authorization:
                    type: Bearer
                    credentials:
                      name: "{{ eda_token_secret_name }}"
                      key: token
  when: eda_enabled | default(true)

- name: Display Alertmanager configuration status
  ansible.builtin.debug:
    msg: |
      AlertmanagerConfig deployed with bearer token authentication:
      - Namespace: {{ tenant_config.namespace }}
      - Webhook URL: {{ eda_webhook_url | default('Not configured') }}
      - Token Secret: {{ eda_token_secret_name }}
      - Secret Created: {{ 'Yes' if eda_token_secret_result is defined and eda_token_secret_result.changed else 'Already exists' }}

      Alerts will be sent to EDA event stream with Authorization: Bearer <token> header.
  when: eda_enabled | default(true)
