---
# Setup Role - Event-Driven Ansible Configuration
# Uses ansible.eda collection to configure EDA components
# Must run BEFORE alertmanager.yml to get event stream webhook URL
#
# Task order:
# 1. Validation (Foundational)
# 2. Token generation (Foundational)
# 3. Credential creation (US1)
# 4. Project creation (US1)
# 5. Event stream creation (US2)
# 6. Rulebook activation (US5)
#
# Connection: Uses aap_hostname (AAP Gateway URL in AAP 2.5+)

# =============================================================================
# Phase 2: Foundational - Validation and Token Generation
# =============================================================================

- name: Validate AAP Gateway connection is configured
  ansible.builtin.assert:
    that:
      - aap_hostname is defined
      - aap_hostname | length > 0
    fail_msg: >-
      aap_hostname must be defined for ansible.eda modules.
      Set AAP_HOSTNAME environment variable or pass aap_hostname variable.
      In AAP 2.5+, this should be the AAP Gateway URL.
    success_msg: "AAP Gateway URL validated: {{ aap_hostname }}"

- name: Validate EDA project URL is defined
  ansible.builtin.assert:
    that:
      - eda_project_url is defined
      - eda_project_url | length > 0
    fail_msg: >-
      eda_project_url must be defined when eda_enabled is true.
      Provide the Git repository URL containing your EDA rulebooks.
    success_msg: "EDA project URL validated: {{ eda_project_url }}"

- name: Generate bearer token if not provided
  ansible.builtin.set_fact:
    eda_generated_token: >-
      {{ eda_token if eda_token | length > 0
         else lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=64') }}

- name: Display EDA configuration
  ansible.builtin.debug:
    msg: |
      Configuring Event-Driven Ansible:
      - AAP Gateway: {{ aap_hostname }}
      - Organization: {{ eda_organization }}
      - Project: {{ eda_project_name }}
      - Project URL: {{ eda_project_url }}
      - Branch: {{ eda_scm_branch }}
      - Decision Environment: {{ eda_decision_environment }}
      - Event Stream: {{ eda_event_stream_name }}
      - Rulebook: {{ eda_rulebook_name }}
      - Token: {{ 'Provided' if eda_token | length > 0 else 'Auto-generated' }}

# =============================================================================
# Phase 3: User Story 1 - EDA Credential and Project Setup
# =============================================================================

- name: Create EDA token credential for event stream
  ansible.eda.credential:
    name: "{{ eda_event_stream_name }}-token"
    description: "Bearer token credential for {{ eda_event_stream_name }} event stream"
    credential_type_name: "Token Event Stream"
    organization_name: "{{ eda_organization }}"
    inputs:
      token: "{{ eda_generated_token }}"
    state: present
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_credential_result

- name: Create EDA project
  ansible.eda.project:
    name: "{{ eda_project_name }}"
    description: "Windows Compliance Collection for STIG remediation"
    url: "{{ eda_project_url }}"
    scm_branch: "{{ eda_scm_branch }}"
    organization_name: "{{ eda_organization }}"
    state: present
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_project_result

- name: Sync EDA project to fetch rulebooks
  ansible.eda.project:
    name: "{{ eda_project_name }}"
    organization_name: "{{ eda_organization }}"
    state: present
    sync: true
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_project_sync_result

- name: Display credential and project creation status
  ansible.builtin.debug:
    msg: |
      EDA Credential and Project Created:
      - Credential: {{ eda_event_stream_name }}-token (ID: {{ eda_credential_result.id | default('N/A') }})
      - Project: {{ eda_project_name }} (ID: {{ eda_project_result.id | default('N/A') }})
      - Project Sync: {{ 'Complete' if eda_project_sync_result is defined else 'Pending' }}

# =============================================================================
# Phase 4: User Story 2 - Event Stream with Authentication
# =============================================================================

- name: Create event stream for compliance alerts
  ansible.eda.event_stream:
    name: "{{ eda_event_stream_name }}"
    credential_name: "{{ eda_event_stream_name }}-token"
    organization_name: "{{ eda_organization }}"
    forward_events: "{{ eda_forward_events }}"
    headers: "{{ eda_headers }}"
    state: present
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_event_stream_result

- name: Debug event stream result structure
  ansible.builtin.debug:
    var: eda_event_stream_result
    verbosity: 1

# Retrieve actual webhook URL from event stream info
# The event_stream module only returns numeric id, but we need the full URL with UUID
- name: Get event stream info for webhook URL
  ansible.eda.event_stream_info:
    name: "{{ eda_event_stream_name }}"
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_event_stream_info

- name: Debug event stream info
  ansible.builtin.debug:
    var: eda_event_stream_info
    verbosity: 1

- name: Extract webhook URL from event stream info
  ansible.builtin.set_fact:
    eda_webhook_url: "{{ eda_event_stream_info.event_streams[0].url }}"
  when: eda_event_stream_info.event_streams | length > 0

- name: Display event stream webhook URL
  ansible.builtin.debug:
    msg: |
      Event Stream Created:
      - Name: {{ eda_event_stream_name }}
      - ID: {{ eda_event_stream_result.id | default('N/A') }}
      - Webhook URL: {{ eda_webhook_url }}
      - Forward Events: {{ eda_forward_events }}
      - Headers: {{ eda_headers }}

      Alertmanager will be configured to send alerts to this webhook.

# =============================================================================
# Phase 6: RH AAP Credential for Rulebook Job Template Access
# =============================================================================
# Rulebook activations that use run_job_template action require an RH AAP credential
# to authenticate with the Automation Controller when triggering jobs.

- name: Set RH AAP credential name
  ansible.builtin.set_fact:
    eda_aap_credential_name_resolved: >-
      {{ eda_aap_credential_name if eda_aap_credential_name | length > 0
         else eda_event_stream_name + '-aap-credential' }}

- name: Create RH AAP credential for rulebook job template access
  ansible.eda.credential:
    name: "{{ eda_aap_credential_name_resolved }}"
    description: "RH AAP credential for {{ eda_event_stream_name }} rulebook to trigger job templates"
    credential_type_name: "Red Hat Ansible Automation Platform"
    organization_name: "{{ eda_organization }}"
    inputs:
      host: "{{ aap_hostname | regex_replace('/$', '') }}/api/controller/"
      username: "{{ aap_username | default(omit) }}"
      password: "{{ aap_password | default(omit) }}"
      oauth_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
      verify_ssl: "{{ aap_validate_certs }}"
    state: present
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_aap_credential_result
  when: eda_aap_credential_name | length == 0

- name: Display RH AAP credential status
  ansible.builtin.debug:
    msg: |
      RH AAP Credential for Rulebook Activations:
      - Name: {{ eda_aap_credential_name_resolved }}
      - ID: {{ eda_aap_credential_result.id | default('Using existing credential') }}
      - Controller URL: {{ aap_hostname }}/api/controller/

      This credential allows rulebooks to trigger job templates on Automation Controller.

# =============================================================================
# Phase 7: User Story 5 - Rulebook Activation with Event Stream Binding
# =============================================================================
# NOTE: Rulebooks must be at extensions/eda/rulebooks/ at the ROOT of the Git repo.
# For Ansible Collections, eda_project_url should point to the collection root:
#   e.g., https://github.com/org/repo.git with subpath to collection directory
# Or the collection must be published and extensions/eda/rulebooks at repo root.

- name: Check if rulebook activation already exists
  ansible.eda.rulebook_activation_info:
    name: "{{ eda_event_stream_name }}-activation"
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_activation_info
  ignore_errors: true

- name: Set activation exists fact
  ansible.builtin.set_fact:
    eda_activation_exists: "{{ eda_activation_info.activations | default([]) | length > 0 }}"
    eda_activation_status: "{{ (eda_activation_info.activations | first).status | default('unknown') if (eda_activation_info.activations | default([]) | length > 0) else 'not_found' }}"

- name: Display existing activation status
  ansible.builtin.debug:
    msg: |
      Rulebook Activation Check:
      - Name: {{ eda_event_stream_name }}-activation
      - Exists: {{ eda_activation_exists }}
      - Status: {{ eda_activation_status }}
      {% if eda_activation_exists and eda_activation_status == 'running' %}
      - Action: Skipping creation (activation is already running)
      {% elif eda_activation_exists %}
      - Action: Deleting and recreating activation
      {% else %}
      - Action: Creating new activation
      {% endif %}

- name: Delete existing rulebook activation if not running
  ansible.eda.rulebook_activation:
    name: "{{ eda_event_stream_name }}-activation"
    state: absent
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  when:
    - eda_activation_exists
    - eda_activation_status != 'running'

- name: Create rulebook activation with event stream binding
  ansible.eda.rulebook_activation:
    name: "{{ eda_event_stream_name }}-activation"
    description: "Auto-remediation for Windows compliance violations"
    project_name: "{{ eda_project_name }}"
    rulebook_name: "{{ eda_rulebook_name }}.yml"
    decision_environment_name: "{{ eda_decision_environment }}"
    organization_name: "{{ eda_organization }}"
    eda_credentials:
      - "{{ eda_aap_credential_name_resolved }}"
    event_streams:
      - event_stream: "{{ eda_event_stream_name }}"
        source_name: "compliance-alerts"
    extra_vars:
      tenant_namespace: "{{ tenant_config.namespace }}"
      auto_remediate_cat1: "{{ eda_auto_remediate_cat1 }}"
      auto_remediate_cat2: "{{ eda_auto_remediate_cat2 }}"
      auto_remediate_cat3: "{{ eda_auto_remediate_cat3 }}"
    state: present
    controller_host: "{{ aap_hostname }}"
    controller_username: "{{ aap_username | default(omit) }}"
    controller_password: "{{ aap_password | default(omit) }}"
    controller_token: "{{ aap_token | default(omit) if aap_token | length > 0 else omit }}"
    validate_certs: "{{ aap_validate_certs }}"
  register: eda_activation_result
  when: not eda_activation_exists or eda_activation_status != 'running'

- name: Display rulebook activation status
  ansible.builtin.debug:
    msg: |
      Rulebook Activation Status:
      - Name: {{ eda_event_stream_name }}-activation
      - ID: {{ eda_activation_result.id | default('Existing activation') }}
      - Project: {{ eda_project_name }}
      - Rulebook: {{ eda_rulebook_name }}.yml
      - Event Stream Binding: {{ eda_event_stream_name }}
      - Auto-Remediate CAT I: {{ eda_auto_remediate_cat1 }}
      - Auto-Remediate CAT II: {{ eda_auto_remediate_cat2 }}
      - Auto-Remediate CAT III: {{ eda_auto_remediate_cat3 }}
      {% if eda_activation_exists and eda_activation_status == 'running' %}
      - Note: Using existing running activation (no changes made)
      {% else %}
      - Note: Activation created/recreated successfully
      {% endif %}

      EDA configuration complete. Alerts will flow from Alertmanager to this rulebook.
