---
# Setup Role - User Workload Monitoring Configuration
# Enables OpenShift user workload monitoring for compliance metrics
# Also enables alertmanagerMain.enableUserAlertmanagerConfig for user-namespace AlertmanagerConfigs

- name: Check if cluster-monitoring-config exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: cluster-monitoring-config
    namespace: openshift-monitoring
  register: cluster_monitoring_config

- name: Parse existing monitoring config
  ansible.builtin.set_fact:
    existing_config: "{{ cluster_monitoring_config.resources[0].data['config.yaml'] | default('') | from_yaml | default({}) }}"
  when: cluster_monitoring_config.resources | length > 0

- name: Set empty config if ConfigMap doesn't exist
  ansible.builtin.set_fact:
    existing_config: {}
  when: cluster_monitoring_config.resources | length == 0

- name: Build required monitoring configuration
  ansible.builtin.set_fact:
    required_config:
      enableUserWorkload: true
      alertmanagerMain:
        enableUserAlertmanagerConfig: true

- name: Merge monitoring configuration
  ansible.builtin.set_fact:
    merged_config: "{{ existing_config | combine(required_config, recursive=True) }}"

- name: Check if configuration update is needed
  ansible.builtin.set_fact:
    config_needs_update: >-
      {{ not (existing_config.get('enableUserWorkload', false) | bool) or
         not (existing_config.get('alertmanagerMain', {}).get('enableUserAlertmanagerConfig', false) | bool) }}

- name: Display configuration changes
  ansible.builtin.debug:
    msg: |
      Cluster monitoring configuration:
      - enableUserWorkload: {{ merged_config.enableUserWorkload }}
      - alertmanagerMain.enableUserAlertmanagerConfig: {{ merged_config.alertmanagerMain.enableUserAlertmanagerConfig }}
      - Update needed: {{ config_needs_update }}

- name: Apply cluster-monitoring-config
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cluster-monitoring-config
        namespace: openshift-monitoring
      data:
        config.yaml: "{{ merged_config | to_nice_yaml }}"
  when: config_needs_update | bool

- name: Wait for user workload monitoring to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: prometheus-operator
    namespace: openshift-user-workload-monitoring
  register: uwm_operator
  until: >-
    uwm_operator.resources | length > 0 and
    (uwm_operator.resources[0].status.readyReplicas | default(0)) > 0
  retries: 30
  delay: 10

- name: Display user workload monitoring status
  ansible.builtin.debug:
    msg: "User workload monitoring is enabled and ready"
