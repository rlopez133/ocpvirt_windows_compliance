---
# Setup Role - AAP Job Templates Configuration
# Creates job templates for compliance operations in AAP/Controller
# Note: Compliance-Setup is skipped as it should be manually created first
#
# Uses awx.awx collection for AWX and AAP compatibility
# Authentication is handled via environment variables injected by AAP credential:
#   CONTROLLER_HOST, CONTROLLER_USERNAME, CONTROLLER_PASSWORD, CONTROLLER_OAUTH_TOKEN
# Attach an "Ansible Automation Platform" credential to the Compliance-Setup job template

- name: Display job template configuration
  ansible.builtin.debug:
    msg: |
      Creating AAP Job Templates:
      - Organization: {{ aap_job_template_organization }}
      - Project: {{ aap_job_template_project }}
      - OpenShift Credential: {{ aap_credential_openshift }}
      - Windows VM Credential: {{ aap_credential_windows }}
      - Windows Inventory: {{ aap_inventory_windows }}
      - S3 Reports Credential: {{ aap_credential_s3_reports | default('Not configured', true) }}

# =============================================================================
# Job Template: Install-SCC
# =============================================================================
- name: Create Install-SCC job template
  awx.awx.job_template:
    name: "Install-SCC"
    description: "Download and install DISA SCAP Compliance Checker on Windows VMs"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/install_scc.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    state: present

# =============================================================================
# Job Template: Compliance-Scan
# =============================================================================
- name: Create Compliance-Scan job template
  awx.awx.job_template:
    name: "Compliance-Scan"
    description: "Run compliance scan on Windows VMs using DISA SCC"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/scan.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    extra_vars:
      compliance_profile: "stig"
    survey_enabled: true
    survey_spec:
      name: "Scan Parameters"
      description: "Configure compliance scan options"
      spec:
        - question_name: "Compliance Profile"
          question_description: "Select the compliance profile to use for scanning"
          variable: "compliance_profile"
          type: "multiplechoice"
          choices:
            - "stig"
            - "stig-minimal"
            - "cis"
            - "hipaa"
            - "pci-dss"
          default: "stig"
          required: true
    state: present

# =============================================================================
# Job Template: Compliance-Remediate
# =============================================================================
- name: Create Compliance-Remediate job template
  awx.awx.job_template:
    name: "Compliance-Remediate"
    description: "Apply compliance remediation to Windows VMs"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/remediate.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    extra_vars:
      compliance_profile: "stig"
      cat_levels:
        - "cat1"
        - "cat2"
    survey_enabled: true
    survey_spec:
      name: "Remediation Parameters"
      description: "Configure remediation options"
      spec:
        - question_name: "Compliance Profile"
          variable: "compliance_profile"
          type: "multiplechoice"
          choices:
            - "stig"
            - "stig-minimal"
            - "cis"
            - "hipaa"
            - "pci-dss"
          default: "stig"
          required: true
        - question_name: "CAT Levels to Apply"
          question_description: "Select which severity levels to remediate"
          variable: "cat_levels"
          type: "multiselect"
          choices:
            - "cat1"
            - "cat2"
            - "cat3"
          default: "cat1\ncat2"
          required: true
    state: present

# =============================================================================
# Job Template: Compliance-Report
# =============================================================================
- name: Build Compliance-Report credentials list
  ansible.builtin.set_fact:
    compliance_report_credentials: >-
      {{ [aap_credential_openshift] + ([aap_credential_s3_reports] if aap_credential_s3_reports | default('', true) | length > 0 else []) }}

- name: Create Compliance-Report job template
  awx.awx.job_template:
    name: "Compliance-Report"
    description: "Generate compliance audit reports"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/report.yml"
    inventory: "localhost"
    credentials: "{{ compliance_report_credentials }}"
    ask_variables_on_launch: true
    extra_vars:
      report_format: "html"
      report_template: "standard"
    survey_enabled: true
    survey_spec:
      name: "Report Parameters"
      spec:
        - question_name: "Report Format"
          variable: "report_format"
          type: "multiplechoice"
          choices:
            - "html"
            - "json"
            - "csv"
          default: "html"
          required: true
        - question_name: "Report Template"
          variable: "report_template"
          type: "multiplechoice"
          choices:
            - "standard"
            - "executive"
            - "detailed"
          default: "standard"
          required: true
    state: present

# =============================================================================
# Job Template: Provision-Compliant-VM
# =============================================================================
- name: Create Provision-Compliant-VM job template
  awx.awx.job_template:
    name: "Provision-Compliant-VM"
    description: "Provision a new Windows VM from a compliant golden image"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/provision_vm.yml"
    inventory: "localhost"
    credentials:
      - "{{ aap_credential_openshift }}"
    ask_variables_on_launch: true
    survey_enabled: true
    survey_spec:
      name: "VM Provisioning Parameters"
      spec:
        - question_name: "VM Name"
          variable: "vm_name"
          type: "text"
          required: true
        - question_name: "Namespace"
          variable: "vm_namespace"
          type: "text"
          required: true
        - question_name: "Golden Image"
          variable: "golden_image_name"
          type: "text"
          default: "win2022-stig-v1"
          required: true
    state: present

# =============================================================================
# Job Template: Create-Golden-Image
# =============================================================================
- name: Create Create-Golden-Image job template
  awx.awx.job_template:
    name: "Create-Golden-Image"
    description: "Create a pre-hardened golden image from a base Windows image"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "playbooks/create_golden_image.yml"
    inventory: "localhost"
    credentials:
      - "{{ aap_credential_openshift }}"
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    survey_enabled: true
    survey_spec:
      name: "Golden Image Parameters"
      spec:
        - question_name: "Image Name"
          variable: "image_name"
          type: "text"
          required: true
        - question_name: "Compliance Profile"
          variable: "compliance_profile"
          type: "multiplechoice"
          choices:
            - "stig"
            - "stig-minimal"
            - "cis"
          default: "stig"
          required: true
        - question_name: "Source DataVolume"
          variable: "source_datavolume"
          type: "text"
          default: "windows-2022-base"
          required: true
    state: present

- name: Display job templates creation status
  ansible.builtin.debug:
    msg: |
      AAP Job Templates Created:
      - Install-SCC
      - Compliance-Scan
      - Compliance-Remediate
      - Compliance-Report
      - Provision-Compliant-VM
      - Create-Golden-Image

      Note: Compliance-Setup was skipped (expected to be pre-created manually)
