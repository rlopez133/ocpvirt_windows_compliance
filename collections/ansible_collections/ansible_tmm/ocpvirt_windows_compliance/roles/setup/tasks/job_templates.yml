---
# Setup Role - AAP Job Templates Configuration
# Creates job templates for compliance operations in AAP/Controller
# Note: Compliance-Setup is skipped as it should be manually created first
#
# Uses ansible.controller collection for AAP 2.5+
# Authentication is handled via environment variables injected by AAP credential:
#   CONTROLLER_HOST, CONTROLLER_USERNAME, CONTROLLER_PASSWORD, CONTROLLER_OAUTH_TOKEN
# Attach an "Ansible Automation Platform" credential to the Compliance-Setup job template

- name: Display job template configuration
  ansible.builtin.debug:
    msg: |
      Creating AAP Job Templates:
      - Organization: {{ aap_job_template_organization }}
      - Project: {{ aap_job_template_project }}
      - Playbook Path Prefix: {{ aap_playbook_path_prefix }}
      - OpenShift Credential: {{ aap_credential_openshift }}
      - Windows VM Credential: {{ aap_credential_windows }}
      - Windows Inventory: {{ aap_inventory_windows }}
      - Localhost Inventory: {{ aap_inventory_localhost }}
      - S3 Reports Credential: {{ aap_credential_s3_reports | default('Not configured', true) }}

# =============================================================================
# Job Template: Install-SCC
# =============================================================================
- name: Create Install-SCC job template
  ansible.controller.job_template:
    name: "Install-SCC"
    description: "Download and install DISA SCAP Compliance Checker on Windows VMs"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/install_scc.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    state: present

# =============================================================================
# Job Template: Compliance-Scan
# =============================================================================
- name: Create Compliance-Scan job template
  ansible.controller.job_template:
    name: "Compliance-Scan"
    description: "Run compliance scan on Windows VMs using DISA SCC"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/scan.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    extra_vars:
      compliance_profile: "stig"
    survey_enabled: true
    survey_spec:
      name: "Scan Parameters"
      description: "Configure compliance scan options"
      spec:
        - question_name: "Compliance Profile"
          question_description: "Select the compliance profile to use for scanning"
          variable: "compliance_profile"
          type: "multiplechoice"
          choices:
            - "stig"
            - "stig-minimal"
          default: "stig"
          required: true
    state: present

# =============================================================================
# Job Template: Compliance-Remediate
# =============================================================================
- name: Create Compliance-Remediate job template
  ansible.controller.job_template:
    name: "Compliance-Remediate"
    description: "Apply compliance remediation to Windows VMs (supports EDA-triggered and scan-driven modes)"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/remediate.yml"
    inventory: "{{ aap_inventory_windows }}"
    credentials:
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    ask_limit_on_launch: true
    extra_vars:
      compliance_profile: "stig"
      dry_run: false
      # EDA passes: trigger_source, category, failed_control_ids, auto_remediate_cat*
      # Scan-driven passes: failed_cat1_controls
      # Example for scan-driven mode:
      #   failed_cat1_controls: ["V-205711", "V-205713", "V-205919"]
      # Example for EDA-triggered mode:
      #   trigger_source: "eda"
      #   category: "CAT2"
      #   failed_control_ids: ["V-205627", "V-205629"]
      #   auto_remediate_cat2: true
    survey_enabled: false
    state: present

# =============================================================================
# Job Template: Compliance-Report
# =============================================================================
- name: Build Compliance-Report credentials list
  ansible.builtin.set_fact:
    compliance_report_credentials: >-
      {{ [aap_credential_openshift] + ([aap_credential_s3_reports] if aap_credential_s3_reports | default('', true) | length > 0 else []) }}

- name: Create Compliance-Report job template
  ansible.controller.job_template:
    name: "Compliance-Report"
    description: "Generate compliance audit reports"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/report.yml"
    inventory: "{{ aap_inventory_localhost }}"
    credentials: "{{ compliance_report_credentials }}"
    ask_variables_on_launch: true
    extra_vars:
      report_format: "html"
      report_template: "standard"
    survey_enabled: true
    survey_spec:
      name: "Report Parameters"
      description: "Configure compliance report generation options"
      spec:
        - question_name: "Report Format"
          question_description: "Select the output format for the compliance report"
          variable: "report_format"
          type: "multiplechoice"
          choices:
            - "html"
            - "json"
            - "csv"
          default: "html"
          required: true
        - question_name: "Report Template"
          question_description: "Select the report template style"
          variable: "report_template"
          type: "multiplechoice"
          choices:
            - "standard"
            - "executive"
            - "detailed"
          default: "standard"
          required: true
    state: present

# =============================================================================
# Job Template: Provision-Compliant-VM
# =============================================================================
- name: Create Provision-Compliant-VM job template
  ansible.controller.job_template:
    name: "Provision-Compliant-VM"
    description: "Provision a new Windows VM from a compliant golden image"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/provision_vm.yml"
    inventory: "{{ aap_inventory_localhost }}"
    credentials:
      - "{{ aap_credential_openshift }}"
    ask_variables_on_launch: true
    survey_enabled: true
    survey_spec:
      name: "VM Provisioning Parameters"
      description: "Configure new Windows VM provisioning options"
      spec:
        - question_name: "VM Name"
          question_description: "Name for the new virtual machine"
          variable: "vm_name"
          type: "text"
          required: true
        - question_name: "Namespace"
          question_description: "OpenShift namespace to deploy the VM"
          variable: "vm_namespace"
          type: "text"
          required: true
        - question_name: "Golden Image"
          question_description: "Name of the compliant golden image to use"
          variable: "golden_image_name"
          type: "text"
          default: "win2022-stig-v1"
          required: true
    state: present

# =============================================================================
# Job Template: Create-Golden-Image
# =============================================================================
- name: Create Create-Golden-Image job template
  ansible.controller.job_template:
    name: "Create-Golden-Image"
    description: "Create a pre-hardened golden image from a base Windows image"
    organization: "{{ aap_job_template_organization }}"
    project: "{{ aap_job_template_project }}"
    playbook: "{{ aap_playbook_path_prefix }}/create_golden_image.yml"
    inventory: "{{ aap_inventory_localhost }}"
    credentials:
      - "{{ aap_credential_openshift }}"
      - "{{ aap_credential_windows }}"
    ask_variables_on_launch: true
    survey_enabled: true
    survey_spec:
      name: "Golden Image Parameters"
      description: "Configure golden image creation options"
      spec:
        - question_name: "Image Name"
          question_description: "Name for the new golden image"
          variable: "image_name"
          type: "text"
          required: true
        - question_name: "Compliance Profile"
          question_description: "Compliance profile to apply to the image"
          variable: "compliance_profile"
          type: "multiplechoice"
          choices:
            - "stig"
            - "stig-minimal"
          default: "stig"
          required: true
        - question_name: "Source DataVolume"
          question_description: "Name of the base Windows DataVolume to use"
          variable: "source_datavolume"
          type: "text"
          default: "windows-2022-base"
          required: true
    state: present

- name: Display job templates creation status
  ansible.builtin.debug:
    msg: |
      AAP Job Templates Created:
      - Install-SCC
      - Compliance-Scan
      - Compliance-Remediate
      - Compliance-Report
      - Provision-Compliant-VM
      - Create-Golden-Image

      Note: Compliance-Setup was skipped (expected to be pre-created manually)
