---
# Setup Role - Main Task Dispatcher
# Configures all infrastructure components for compliance management
#
# Task Order (EDA-first pattern):
# 1. EDA Setup (eda.yml) - Creates credential, project, event stream, and rulebook activation
# 2. Alertmanager (alertmanager.yml) - Deploys token secret and webhook config using EDA URL
# 3. Monitoring (monitoring.yml) - Enables user workload monitoring
# 4. Prometheus Rules (prometheus_rules.yml) - Deploys compliance alert rules
# 5. Grafana (grafana.yml) - Deploys dashboards
# 6. Storage (storage.yml) - Creates PVCs for reports

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - tenant_config is defined
      - tenant_config.namespace is defined
      - tenant_config.name is defined
    fail_msg: "tenant_config with namespace and name is required"

- name: Display setup configuration
  ansible.builtin.debug:
    msg: |
      Setting up compliance infrastructure for tenant: {{ tenant_config.name }}
      Namespace: {{ tenant_config.namespace }}
      EDA Enabled: {{ eda_enabled }}

# EDA must be configured FIRST to get the event stream webhook URL
- name: Configure Event-Driven Ansible
  ansible.builtin.include_tasks: eda.yml
  when: eda_enabled | default(true)

# Alertmanager uses the webhook URL from EDA
- name: Configure Alertmanager
  ansible.builtin.include_tasks: alertmanager.yml
  when: ocpvirt_compliance_alertmanager_dedicated | default(true)

- name: Configure user workload monitoring
  ansible.builtin.include_tasks: monitoring.yml
  when: ocpvirt_compliance_enable_user_workload_monitoring | default(true)

- name: Deploy Prometheus rules
  ansible.builtin.include_tasks: prometheus_rules.yml

- name: Deploy Grafana dashboards
  ansible.builtin.include_tasks: grafana.yml
  when: ocpvirt_compliance_grafana_dashboards | default(true)

- name: Create storage resources
  ansible.builtin.include_tasks: storage.yml

- name: Create AAP job templates
  ansible.builtin.include_tasks: job_templates.yml
  when: aap_create_job_templates | default(true)

- name: Display setup summary
  ansible.builtin.debug:
    msg: |
      Compliance infrastructure setup complete!
      - Namespace: {{ tenant_config.namespace }}
      - EDA: {{ 'Configured' if eda_enabled else 'Skipped' }}
      - Alertmanager: {{ 'Configured' if ocpvirt_compliance_alertmanager_dedicated else 'Skipped' }}
      - PrometheusRules: Deployed
      - Grafana Dashboards: {{ 'Deployed' if ocpvirt_compliance_grafana_dashboards else 'Skipped' }}
      - AAP Job Templates: {{ 'Created' if aap_create_job_templates | default(true) else 'Skipped' }}
