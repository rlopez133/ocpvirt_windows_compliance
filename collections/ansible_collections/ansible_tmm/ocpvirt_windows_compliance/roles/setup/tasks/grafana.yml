---
# Setup Role - Grafana Dashboard Deployment
# Deploys Grafana dashboards for compliance visualization
# Dashboard JSON is stored in files/grafana_dashboards/ to avoid Jinja2 templating issues

- name: Read Grafana dashboard JSON file
  ansible.builtin.slurp:
    src: "{{ role_path }}/files/grafana_dashboards/compliance-dashboard.json"
  register: dashboard_file

- name: Deploy Grafana dashboard ConfigMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: grafana-dashboard-compliance
        namespace: "{{ tenant_config.namespace }}"
        labels:
          grafana_dashboard: "1"
          app.kubernetes.io/name: ocpvirt-windows-compliance
          app.kubernetes.io/component: dashboard
      data:
        compliance-dashboard.json: "{{ dashboard_file.content | b64decode }}"

- name: Display dashboard deployment status
  ansible.builtin.debug:
    msg: "Grafana dashboard ConfigMap deployed to {{ tenant_config.namespace }}"
