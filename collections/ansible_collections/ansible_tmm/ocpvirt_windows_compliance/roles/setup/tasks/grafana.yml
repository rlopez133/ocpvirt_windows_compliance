---
# Setup Role - Grafana Dashboard Deployment
# Deploys Grafana dashboards for compliance visualization

- name: Define Grafana dashboard
  ansible.builtin.set_fact:
    compliance_dashboard:
      annotations:
        list: []
      editable: true
      fiscalYearStartMonth: 0
      graphTooltip: 0
      id: null
      links: []
      liveNow: false
      panels:
        - datasource:
            type: prometheus
            uid: prometheus
          fieldConfig:
            defaults:
              color:
                mode: thresholds
              mappings: []
              thresholds:
                mode: absolute
                steps:
                  - color: red
                    value: null
                  - color: yellow
                    value: 80
                  - color: green
                    value: 95
              unit: percent
          gridPos:
            h: 8
            w: 6
            x: 0
            y: 0
          id: 1
          options:
            orientation: auto
            reduceOptions:
              calcs:
                - lastNotNull
              fields: ""
              values: false
            showThresholdLabels: false
            showThresholdMarkers: true
          pluginVersion: "10.0.0"
          targets:
            - expr: 'avg(compliance_score{namespace="$namespace"})'
              refId: A
          title: Average Compliance Score
          type: gauge
        - datasource:
            type: prometheus
            uid: prometheus
          fieldConfig:
            defaults:
              color:
                mode: palette-classic
              mappings: []
              thresholds:
                mode: absolute
                steps:
                  - color: green
                    value: null
          gridPos:
            h: 8
            w: 6
            x: 6
            y: 0
          id: 2
          options:
            colorMode: value
            graphMode: area
            justifyMode: auto
            orientation: auto
            reduceOptions:
              calcs:
                - lastNotNull
              fields: ""
              values: false
            textMode: auto
          pluginVersion: "10.0.0"
          targets:
            - expr: 'count(compliance_score{namespace="$namespace"})'
              refId: A
          title: VMs Monitored
          type: stat
        - datasource:
            type: prometheus
            uid: prometheus
          fieldConfig:
            defaults:
              color:
                mode: palette-classic
              mappings: []
              thresholds:
                mode: absolute
                steps:
                  - color: green
                    value: null
                  - color: yellow
                    value: 1
                  - color: red
                    value: 5
          gridPos:
            h: 8
            w: 6
            x: 12
            y: 0
          id: 3
          options:
            colorMode: value
            graphMode: area
            justifyMode: auto
            orientation: auto
            reduceOptions:
              calcs:
                - lastNotNull
              fields: ""
              values: false
            textMode: auto
          pluginVersion: "10.0.0"
          targets:
            - expr: 'count(compliance_control_status{namespace="$namespace", category="CAT1", status="fail"} == 1)'
              refId: A
          title: CAT I Violations
          type: stat
        - datasource:
            type: prometheus
            uid: prometheus
          fieldConfig:
            defaults:
              color:
                mode: palette-classic
              custom:
                axisCenteredZero: false
                axisColorMode: text
                axisLabel: ""
                axisPlacement: auto
                barAlignment: 0
                drawStyle: line
                fillOpacity: 10
                gradientMode: none
                hideFrom:
                  legend: false
                  tooltip: false
                  viz: false
                lineInterpolation: linear
                lineWidth: 1
                pointSize: 5
                scaleDistribution:
                  type: linear
                showPoints: auto
                spanNulls: false
                stacking:
                  group: A
                  mode: none
                thresholdsStyle:
                  mode: "off"
              mappings: []
              thresholds:
                mode: absolute
                steps:
                  - color: green
                    value: null
              unit: percent
          gridPos:
            h: 8
            w: 24
            x: 0
            y: 8
          id: 4
          options:
            legend:
              calcs: []
              displayMode: list
              placement: bottom
              showLegend: true
            tooltip:
              mode: single
              sort: none
          pluginVersion: "10.0.0"
          targets:
            - expr: 'compliance_score{namespace="$namespace"}'
              legendFormat: "{% raw %}{{ vm_name }}{% endraw %}"
              refId: A
          title: Compliance Score Over Time
          type: timeseries
      refresh: 30s
      schemaVersion: 38
      style: dark
      tags:
        - compliance
        - windows
        - stig
      templating:
        list:
          - current: {}
            datasource:
              type: prometheus
              uid: prometheus
            definition: "label_values(compliance_score, namespace)"
            hide: 0
            includeAll: true
            label: Namespace
            multi: false
            name: namespace
            options: []
            query:
              query: "label_values(compliance_score, namespace)"
              refId: A
            refresh: 1
            regex: ""
            skipUrlSync: false
            sort: 1
            type: query
      time:
        from: now-24h
        to: now
      timepicker: {}
      timezone: ""
      title: Windows Compliance Dashboard
      uid: windows-compliance
      version: 1
      weekStart: ""

- name: Deploy Grafana dashboard ConfigMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: grafana-dashboard-compliance
        namespace: "{{ tenant_config.namespace }}"
        labels:
          grafana_dashboard: "1"
          app.kubernetes.io/name: ocpvirt-windows-compliance
          app.kubernetes.io/component: dashboard
      data:
        compliance-dashboard.json: "{{ compliance_dashboard | to_json }}"

- name: Display dashboard deployment status
  ansible.builtin.debug:
    msg: "Grafana dashboard ConfigMap deployed to {{ tenant_config.namespace }}"
