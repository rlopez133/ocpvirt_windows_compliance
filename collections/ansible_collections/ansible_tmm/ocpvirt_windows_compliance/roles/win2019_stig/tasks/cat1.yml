---
# Windows Server 2019 STIG - CAT I (High Severity) Controls

# Initialize result tracking for this category
- name: "CAT1 | Initialize remediation tracking"
  ansible.builtin.set_fact:
    cat1_results: "{{ cat1_results | default([]) }}"
    _cat1_task_results: []
  tags:
    - cat1
    - tracking

# WN19-00-000010 - Windows Server 2019 must be a supported release
- name: "CAT1 | WN19-00-000010 | Verify Windows 2019 is current"
  when: "'WN19-00-000010' not in win19stig_skip_rules"
  ansible.builtin.debug:
    msg: "Checking Windows Server 2019 is up to date - manual verification required"
  register: _wn19_00_000010
  tags:
    - cat1
    - WN19-00-000010

# WN19-00-000020 - Outdated or unused accounts must be removed
- name: "CAT1 | WN19-00-000020 | Check for inactive accounts"
  when: "'WN19-00-000020' not in win19stig_skip_rules"
  ansible.windows.win_powershell:
    script: |
      $threshold = (Get-Date).AddDays(-35)
      Get-LocalUser | Where-Object { $_.Enabled -and $_.LastLogon -lt $threshold } |
        Select-Object Name, LastLogon | ConvertTo-Json
  register: _wn19_00_000020
  tags:
    - cat1
    - WN19-00-000020

# WN19-00-000030 - Accounts with blank passwords must be disabled
- name: "CAT1 | WN19-00-000030 | Ensure no blank passwords"
  when: "'WN19-00-000030' not in win19stig_skip_rules"
  community.windows.win_security_policy:
    section: System Access
    key: LimitBlankPasswordUse
    value: 1
  register: _wn19_00_000030
  tags:
    - cat1
    - WN19-00-000030

# WN19-AC-000010 - Account lockout threshold
- name: "CAT1 | WN19-AC-000010 | Configure account lockout threshold"
  when: "'WN19-AC-000010' not in win19stig_skip_rules"
  community.windows.win_security_policy:
    section: System Access
    key: LockoutBadCount
    value: "{{ win19stig_lockout_policy.threshold }}"
  register: _wn19_ac_000010
  tags:
    - cat1
    - WN19-AC-000010

# WN19-SO-000010 - Anonymous SID/Name translation must be disabled
- name: "CAT1 | WN19-SO-000010 | Disable anonymous SID/Name translation"
  when: "'WN19-SO-000010' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: AnonymousNameLookup
    data: 0
    type: dword
  register: _wn19_so_000010
  tags:
    - cat1
    - WN19-SO-000010

# WN19-SO-000020 - Anonymous enumeration of SAM accounts must be disabled
- name: "CAT1 | WN19-SO-000020 | Disable anonymous SAM enumeration"
  when: "'WN19-SO-000020' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: RestrictAnonymousSAM
    data: 1
    type: dword
  register: _wn19_so_000020
  tags:
    - cat1
    - WN19-SO-000020

# WN19-SO-000030 - Anonymous enumeration of shares must be restricted
- name: "CAT1 | WN19-SO-000030 | Restrict anonymous share enumeration"
  when: "'WN19-SO-000030' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: RestrictAnonymous
    data: 1
    type: dword
  register: _wn19_so_000030
  tags:
    - cat1
    - WN19-SO-000030

# WN19-SO-000040 - LAN Manager hash must not be stored
- name: "CAT1 | WN19-SO-000040 | Disable LAN Manager hash storage"
  when: "'WN19-SO-000040' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: NoLMHash
    data: 1
    type: dword
  register: _wn19_so_000040
  tags:
    - cat1
    - WN19-SO-000040

# WN19-SO-000050 - LAN Manager authentication level
- name: "CAT1 | WN19-SO-000050 | Set LM authentication to NTLMv2 only"
  when: "'WN19-SO-000050' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: LmCompatibilityLevel
    data: 5
    type: dword
  register: _wn19_so_000050
  tags:
    - cat1
    - WN19-SO-000050

# WN19-SO-000060 - LDAP client signing must be required
- name: "CAT1 | WN19-SO-000060 | Require LDAP client signing"
  when: "'WN19-SO-000060' not in win19stig_skip_rules"
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LDAP
    name: LDAPClientIntegrity
    data: 2
    type: dword
  register: _wn19_so_000060
  tags:
    - cat1
    - WN19-SO-000060

# WN19-CC-000010 - Credential Guard (where supported)
- name: "CAT1 | WN19-CC-000010 | Enable Credential Guard"
  when:
    - "'WN19-CC-000010' not in win19stig_skip_rules"
    - win19stig_security_options.credential_guard | default(false)
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard
    name: EnableVirtualizationBasedSecurity
    data: 1
    type: dword
  register: _wn19_cc_000010
  tags:
    - cat1
    - WN19-CC-000010

# ============================================================================
# WinRM Authentication Controls - Requires NTLM Transport
# These controls disable Basic auth. They ONLY run if ansible_winrm_transport
# is set to 'ntlm' to prevent locking out the Ansible connection.
#
# Flow: Run bootstrap_winrm.yml first (with Basic) to enable NTLM, then
#       switch inventory to NTLM, then remediation can disable Basic.
# ============================================================================

- name: "CAT1 | Detect current WinRM transport"
  ansible.builtin.set_fact:
    _current_winrm_transport: "{{ ansible_winrm_transport | default('basic') | lower }}"
  tags:
    - cat1
    - WN19-CC-000470
    - WN19-CC-000500

- name: "CAT1 | WN19-CC-000470 | Disable WinRM Client Basic authentication"
  when:
    - "'WN19-CC-000470' not in win19stig_skip_rules"
    - _current_winrm_transport in ['ntlm', 'kerberos', 'credssp']
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
    name: AllowBasic
    data: 0
    type: dword
  register: _wn19_cc_000470
  tags:
    - cat1
    - WN19-CC-000470

- name: "CAT1 | WN19-CC-000470 | Skipped - requires NTLM transport"
  when:
    - "'WN19-CC-000470' not in win19stig_skip_rules"
    - _current_winrm_transport not in ['ntlm', 'kerberos', 'credssp']
  ansible.builtin.debug:
    msg: |
      SKIPPED: WN19-CC-000470 - Disabling WinRM Basic auth requires NTLM transport.
      Current transport: {{ _current_winrm_transport }}
      Run bootstrap_winrm.yml first, then switch inventory to NTLM.
  register: _wn19_cc_000470_skipped
  tags:
    - cat1
    - WN19-CC-000470

- name: "CAT1 | WN19-CC-000500 | Disable WinRM Service Basic authentication"
  when:
    - "'WN19-CC-000500' not in win19stig_skip_rules"
    - _current_winrm_transport in ['ntlm', 'kerberos', 'credssp']
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
    name: AllowBasic
    data: 0
    type: dword
  register: _wn19_cc_000500
  tags:
    - cat1
    - WN19-CC-000500

- name: "CAT1 | WN19-CC-000500 | Skipped - requires NTLM transport"
  when:
    - "'WN19-CC-000500' not in win19stig_skip_rules"
    - _current_winrm_transport not in ['ntlm', 'kerberos', 'credssp']
  ansible.builtin.debug:
    msg: |
      SKIPPED: WN19-CC-000500 - Disabling WinRM Basic auth requires NTLM transport.
      Current transport: {{ _current_winrm_transport }}
      Run bootstrap_winrm.yml first, then switch inventory to NTLM.
  register: _wn19_cc_000500_skipped
  tags:
    - cat1
    - WN19-CC-000500

- name: "CAT1 | Restart WinRM after disabling Basic auth"
  when:
    - (_wn19_cc_000470.changed | default(false)) or (_wn19_cc_000500.changed | default(false))
  ansible.windows.win_shell: |
    # Schedule WinRM restart after a 2-second delay to allow this command to complete
    Start-Process powershell -ArgumentList '-Command', 'Start-Sleep -Seconds 2; Restart-Service WinRM -Force' -WindowStyle Hidden
  async: 10
  poll: 0
  register: _winrm_restart_async
  tags:
    - cat1
    - WN19-CC-000470
    - WN19-CC-000500

- name: "CAT1 | Wait for WinRM to restart"
  when:
    - (_wn19_cc_000470.changed | default(false)) or (_wn19_cc_000500.changed | default(false))
  ansible.builtin.wait_for_connection:
    delay: 5
    timeout: 120
    sleep: 5
  tags:
    - cat1
    - WN19-CC-000470
    - WN19-CC-000500

# ============================================================================
# Aggregate CAT I Results
# ============================================================================
- name: "CAT1 | Aggregate remediation results"
  ansible.builtin.set_fact:
    cat1_results: >-
      {{
        [
          {'control_id': 'WN19-00-000010', 'status': 'skipped' if (_wn19_00_000010.skipped | default(false)) else 'ok'},
          {'control_id': 'WN19-00-000020', 'status': 'skipped' if (_wn19_00_000020.skipped | default(false)) else ('changed' if (_wn19_00_000020.changed | default(false)) else 'ok')},
          {'control_id': 'WN19-00-000030', 'status': 'skipped' if (_wn19_00_000030.skipped | default(false)) else ('failed' if (_wn19_00_000030.failed | default(false)) else ('changed' if (_wn19_00_000030.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-AC-000010', 'status': 'skipped' if (_wn19_ac_000010.skipped | default(false)) else ('failed' if (_wn19_ac_000010.failed | default(false)) else ('changed' if (_wn19_ac_000010.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000010', 'status': 'skipped' if (_wn19_so_000010.skipped | default(false)) else ('failed' if (_wn19_so_000010.failed | default(false)) else ('changed' if (_wn19_so_000010.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000020', 'status': 'skipped' if (_wn19_so_000020.skipped | default(false)) else ('failed' if (_wn19_so_000020.failed | default(false)) else ('changed' if (_wn19_so_000020.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000030', 'status': 'skipped' if (_wn19_so_000030.skipped | default(false)) else ('failed' if (_wn19_so_000030.failed | default(false)) else ('changed' if (_wn19_so_000030.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000040', 'status': 'skipped' if (_wn19_so_000040.skipped | default(false)) else ('failed' if (_wn19_so_000040.failed | default(false)) else ('changed' if (_wn19_so_000040.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000050', 'status': 'skipped' if (_wn19_so_000050.skipped | default(false)) else ('failed' if (_wn19_so_000050.failed | default(false)) else ('changed' if (_wn19_so_000050.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-SO-000060', 'status': 'skipped' if (_wn19_so_000060.skipped | default(false)) else ('failed' if (_wn19_so_000060.failed | default(false)) else ('changed' if (_wn19_so_000060.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-CC-000010', 'status': 'skipped' if (_wn19_cc_000010.skipped | default(false)) else ('failed' if (_wn19_cc_000010.failed | default(false)) else ('changed' if (_wn19_cc_000010.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-CC-000470', 'status': 'skipped' if (_wn19_cc_000470_skipped is defined or _wn19_cc_000470.skipped | default(false)) else ('failed' if (_wn19_cc_000470.failed | default(false)) else ('changed' if (_wn19_cc_000470.changed | default(false)) else 'ok'))},
          {'control_id': 'WN19-CC-000500', 'status': 'skipped' if (_wn19_cc_000500_skipped is defined or _wn19_cc_000500.skipped | default(false)) else ('failed' if (_wn19_cc_000500.failed | default(false)) else ('changed' if (_wn19_cc_000500.changed | default(false)) else 'ok'))}
        ]
      }}
  tags:
    - cat1
    - tracking
