---
# Windows Server 2019 STIG - WinRM Migration
# Safely migrates from Basic to NTLM authentication before disabling Basic auth
#
# This handles V-205711 and V-205713 (WinRM Basic auth controls) safely
# to avoid locking out Ansible connectivity

- name: Display WinRM migration notice
  ansible.builtin.debug:
    msg: |
      WinRM Authentication Migration
      ===============================
      Migrating from Basic to NTLM authentication.
      This is required before disabling Basic auth (V-205711, V-205713).

# ============================================================================
# Step 1: Verify current WinRM configuration
# ============================================================================
- name: Get current WinRM configuration
  ansible.windows.win_shell: |
    $config = @{
        ClientAllowBasic = (Get-Item WSMan:\localhost\Client\Auth\Basic -ErrorAction SilentlyContinue).Value
        ServiceAllowBasic = (Get-Item WSMan:\localhost\Service\Auth\Basic -ErrorAction SilentlyContinue).Value
        ClientAllowNTLM = (Get-Item WSMan:\localhost\Client\Auth\Negotiate -ErrorAction SilentlyContinue).Value
        ServiceAllowNTLM = (Get-Item WSMan:\localhost\Service\Auth\Negotiate -ErrorAction SilentlyContinue).Value
        HttpsListener = (Get-Item WSMan:\localhost\Listener\*\* -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq 'Transport' -and $_.Value -eq 'HTTPS' }) -ne $null
    }
    $config | ConvertTo-Json -Compress
  register: winrm_current_config
  changed_when: false

- name: Parse WinRM configuration
  ansible.builtin.set_fact:
    winrm_config: "{{ winrm_current_config.stdout | from_json }}"

- name: Display current WinRM auth status
  ansible.builtin.debug:
    msg: |
      Current WinRM Authentication Status:
      - Client Basic Auth: {{ winrm_config.ClientAllowBasic | default('Not Set') }}
      - Service Basic Auth: {{ winrm_config.ServiceAllowBasic | default('Not Set') }}
      - Client NTLM/Negotiate: {{ winrm_config.ClientAllowNTLM | default('Not Set') }}
      - Service NTLM/Negotiate: {{ winrm_config.ServiceAllowNTLM | default('Not Set') }}
      - HTTPS Listener: {{ winrm_config.HttpsListener | default(false) }}

# ============================================================================
# Step 2: Enable NTLM/Negotiate authentication (if not already enabled)
# ============================================================================
- name: Ensure NTLM/Negotiate authentication is enabled on WinRM Service
  ansible.windows.win_shell: |
    Set-Item WSMan:\localhost\Service\Auth\Negotiate -Value $true
    Set-Item WSMan:\localhost\Service\Auth\Kerberos -Value $true
  register: enable_ntlm_service
  changed_when: true

- name: Ensure NTLM/Negotiate authentication is enabled on WinRM Client
  ansible.windows.win_shell: |
    Set-Item WSMan:\localhost\Client\Auth\Negotiate -Value $true
    Set-Item WSMan:\localhost\Client\Auth\Kerberos -Value $true
  register: enable_ntlm_client
  changed_when: true

# ============================================================================
# Step 3: Verify HTTPS listener exists (required for secure NTLM)
# ============================================================================
- name: Check for HTTPS listener
  ansible.windows.win_shell: |
    $httpsListeners = Get-ChildItem WSMan:\localhost\Listener | Where-Object {
        $transport = (Get-ChildItem $_.PSPath | Where-Object { $_.Name -eq 'Transport' }).Value
        $transport -eq 'HTTPS'
    }
    if ($httpsListeners) {
        @{ exists = $true; count = $httpsListeners.Count } | ConvertTo-Json -Compress
    } else {
        @{ exists = $false; count = 0 } | ConvertTo-Json -Compress
    }
  register: https_listener_check
  changed_when: false

- name: Parse HTTPS listener status
  ansible.builtin.set_fact:
    https_listener: "{{ https_listener_check.stdout | from_json }}"

- name: Warn if HTTPS listener not found
  when: not https_listener.exists
  ansible.builtin.debug:
    msg: |
      WARNING: No HTTPS listener found for WinRM.
      NTLM authentication over HTTP is less secure.
      Consider configuring HTTPS for WinRM before proceeding.

      Continuing with migration as HTTPS is already configured per user confirmation.

# ============================================================================
# Step 4: Restart WinRM to apply NTLM settings before disabling Basic
# ============================================================================
- name: Restart WinRM service to apply NTLM settings
  ansible.windows.win_service:
    name: WinRM
    state: restarted
  register: winrm_restart_ntlm

- name: Wait for WinRM to be ready after NTLM enable
  ansible.builtin.wait_for_connection:
    delay: 5
    timeout: 60

# ============================================================================
# Step 5: Now safe to disable Basic authentication
# Uses block/rescue to handle partial failure gracefully
# ============================================================================
- name: Disable Basic authentication with rollback protection
  block:
    - name: Disable Basic authentication on WinRM Client (V-205711)
      ansible.windows.win_regedit:
        path: "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Client"
        name: "AllowBasic"
        data: 0
        type: dword
      register: disable_basic_client

    - name: Disable Basic authentication on WinRM Service (V-205713)
      ansible.windows.win_regedit:
        path: "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Service"
        name: "AllowBasic"
        data: 0
        type: dword
      register: disable_basic_service

  rescue:
    - name: WinRM migration partial failure - NTLM remains enabled (safe state)
      ansible.builtin.debug:
        msg: |
          WARNING: WinRM migration encountered an error during Basic auth disable.
          NTLM/Negotiate authentication has been enabled successfully.
          Basic authentication may still be enabled - manual review required.

          This is a safe state - connectivity is maintained.
          Review the error and manually disable Basic auth if needed.

    - name: Set migration failure flag
      ansible.builtin.set_fact:
        winrm_migration_partial_failure: true

# ============================================================================
# Step 6: Restart WinRM and verify connectivity
# ============================================================================
- name: Restart WinRM service to apply all changes
  ansible.windows.win_service:
    name: WinRM
    state: restarted
  when:
    - winrm_migration_partial_failure is not defined or not winrm_migration_partial_failure
    - disable_basic_client is defined and disable_basic_client.changed or disable_basic_service is defined and disable_basic_service.changed

- name: Wait for WinRM to be ready after disabling Basic auth
  ansible.builtin.wait_for_connection:
    delay: 5
    timeout: 60
  when: winrm_migration_partial_failure is not defined or not winrm_migration_partial_failure

# ============================================================================
# Step 7: Verify final configuration
# ============================================================================
- name: Verify final WinRM configuration
  ansible.windows.win_shell: |
    $config = @{
        ClientAllowBasic = (Get-Item WSMan:\localhost\Client\Auth\Basic -ErrorAction SilentlyContinue).Value
        ServiceAllowBasic = (Get-Item WSMan:\localhost\Service\Auth\Basic -ErrorAction SilentlyContinue).Value
        ClientAllowNTLM = (Get-Item WSMan:\localhost\Client\Auth\Negotiate -ErrorAction SilentlyContinue).Value
        ServiceAllowNTLM = (Get-Item WSMan:\localhost\Service\Auth\Negotiate -ErrorAction SilentlyContinue).Value
    }
    $config | ConvertTo-Json -Compress
  register: winrm_final_config
  changed_when: false

- name: Parse final WinRM configuration
  ansible.builtin.set_fact:
    winrm_final: "{{ winrm_final_config.stdout | from_json }}"

- name: Display WinRM migration result
  ansible.builtin.debug:
    msg: |
      WinRM Migration Complete
      ========================
      Final Authentication Status:
      - Client Basic Auth: {{ winrm_final.ClientAllowBasic }} (should be false)
      - Service Basic Auth: {{ winrm_final.ServiceAllowBasic }} (should be false)
      - Client NTLM/Negotiate: {{ winrm_final.ClientAllowNTLM }} (should be true)
      - Service NTLM/Negotiate: {{ winrm_final.ServiceAllowNTLM }} (should be true)

      Controls remediated:
      - V-205711 (WN19-CC-000470): WinRM Client Basic Auth Disabled
      - V-205713 (WN19-CC-000500): WinRM Service Basic Auth Disabled

      IMPORTANT: Update your Ansible inventory to use ansible_winrm_transport: ntlm
