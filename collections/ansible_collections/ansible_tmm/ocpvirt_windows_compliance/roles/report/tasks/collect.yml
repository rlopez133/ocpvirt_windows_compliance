---
# Report Role - Collect Data
# Gathers scan results and remediation history

- name: Query Prometheus for compliance metrics
  ansible.builtin.uri:
    url: "{{ prometheus_url | default('http://prometheus-k8s.openshift-monitoring.svc:9090') }}/api/v1/query"
    method: GET
    body_format: form-urlencoded
    body:
      query: 'compliance_score{namespace="{{ tenant_namespace }}"}'
    return_content: true
  register: prometheus_scores
  delegate_to: localhost
  ignore_errors: true

- name: Query scan history
  ansible.builtin.uri:
    url: "{{ prometheus_url | default('http://prometheus-k8s.openshift-monitoring.svc:9090') }}/api/v1/query_range"
    method: GET
    body_format: form-urlencoded
    body:
      query: 'compliance_score{namespace="{{ tenant_namespace }}"}'
      start: "{{ report_period_start | default((ansible_date_time.epoch | int - 2592000) | string) }}"
      end: "{{ report_period_end | default(ansible_date_time.epoch) }}"
      step: "1h"
    return_content: true
  register: prometheus_history
  delegate_to: localhost
  ignore_errors: true

- name: Parse compliance data
  ansible.builtin.set_fact:
    compliance_data:
      current_scores: "{{ prometheus_scores.json.data.result | default([]) }}"
      history: "{{ prometheus_history.json.data.result | default([]) }}"

- name: Calculate summary statistics
  ansible.builtin.set_fact:
    report_summary:
      vms_covered: "{{ compliance_data.current_scores | length }}"
      average_score: "{{ compliance_data.current_scores | map(attribute='value') | map('last') | map('float') | list | average | default(0) | round(1) }}"
      period_start: "{{ report_period_start | default('30 days ago') }}"
      period_end: "{{ report_period_end | default('now') }}"
      generated: "{{ ansible_date_time.iso8601 }}"
