---
# Remediate Role - Main Task Dispatcher
# Scan-driven CAT I remediation only
# Only fixes controls that failed in the scan results

- name: Validate remediation configuration
  ansible.builtin.assert:
    that:
      - failed_cat1_controls is defined
    fail_msg: "failed_cat1_controls must be provided from scan results"

- name: Gather Windows facts
  ansible.windows.win_powershell:
    script: |
      $os = Get-CimInstance Win32_OperatingSystem
      @{
        Caption = $os.Caption
        Version = $os.Version
        BuildNumber = $os.BuildNumber
      } | ConvertTo-Json -Compress
  register: os_info_raw

- name: Parse OS information
  ansible.builtin.set_fact:
    # win_powershell.output is a list, join it to get the JSON string
    os_info: "{{ (os_info_raw.output | join('')) | from_json }}"

- name: Determine Windows version
  ansible.builtin.set_fact:
    windows_version: >-
      {%- if '2022' in os_info.Caption -%}
        2022
      {%- elif '2019' in os_info.Caption -%}
        2019
      {%- else -%}
        unknown
      {%- endif -%}

- name: Create system restore point
  when: remediation.create_restore_point | default(true) and not dry_run
  ansible.windows.win_powershell:
    script: |
      Checkpoint-Computer -Description "Pre-Compliance-Remediation-{{ ansible_date_time.iso8601 }}" -RestorePointType MODIFY_SETTINGS
  ignore_errors: true

- name: Log remediation start
  ansible.builtin.set_fact:
    remediation_start_time: "{{ ansible_date_time.iso8601 }}"

# ============================================================================
# Apply scan-driven remediation based on failed controls
# ============================================================================
- name: Apply Windows 2019 STIG scan-driven remediation
  when:
    - windows_version == '2019'
    - failed_cat1_controls | length > 0
  ansible.builtin.include_tasks:
    file: "{{ playbook_dir }}/../roles/win2019_stig/tasks/scan_driven_remediation.yml"
  vars:
    failed_cat1_controls: "{{ failed_cat1_controls }}"

- name: Skip remediation - no failed CAT I controls
  when: failed_cat1_controls | length == 0
  ansible.builtin.debug:
    msg: "No failed CAT I controls to remediate. System may already be compliant."

- name: Fail if OS not supported
  when: windows_version == 'unknown'
  ansible.builtin.fail:
    msg: "Unsupported Windows version: {{ os_info.Caption }}. Only Windows Server 2019 is currently supported."

- name: Fail if Windows 2022 (not yet implemented)
  when: windows_version == '2022'
  ansible.builtin.fail:
    msg: "Windows Server 2022 scan-driven remediation not yet implemented. Coming soon."

- name: Log remediation completion
  ansible.builtin.set_fact:
    remediation_result:
      started: "{{ remediation_start_time }}"
      completed: "{{ ansible_date_time.iso8601 }}"
      os_version: "{{ windows_version }}"
      profile: "{{ compliance_profile }}"
      trigger: "{{ trigger_source }}"
      dry_run: "{{ dry_run }}"
      failed_cat1_count: "{{ failed_cat1_controls | length }}"
      # Include scan-driven results if available
      automatable_controls: "{{ automatable_controls | default([]) }}"
      manual_controls: "{{ manual_controls | default([]) }}"
      unknown_v_ids: "{{ unknown_v_ids | default([]) }}"
      registry_changed: "{{ registry_changed_count | default(0) }}"
      multi_registry_changed: "{{ multi_registry_changed_count | default(0) }}"
      security_policy_changed: "{{ security_policy_changed_count | default(0) }}"
      user_rights_changed: "{{ user_rights_changed_count | default(0) }}"
      winrm_in_manual: "{{ winrm_in_manual | default(false) }}"

# ============================================================================
# Push remediation metrics to Prometheus
# ============================================================================
- name: Build remediation metrics payload
  ansible.builtin.set_fact:
    remediation_metrics_payload: |
      # HELP compliance_remediations_total Total remediation operations
      # TYPE compliance_remediations_total counter
      compliance_remediations_total{vm_name="{{ inventory_hostname }}",namespace="{{ hostvars[inventory_hostname]['namespace'] | default('unknown') }}",trigger="{{ trigger_source | default('manual') }}",result="{{ 'success' if (automatable_controls | default([]) | length) > 0 else 'skipped' }}"} 1

      # HELP compliance_remediation_controls_attempted Number of controls attempted to remediate
      # TYPE compliance_remediation_controls_attempted gauge
      compliance_remediation_controls_attempted{vm_name="{{ inventory_hostname }}",namespace="{{ hostvars[inventory_hostname]['namespace'] | default('unknown') }}"} {{ automatable_controls | default([]) | length }}

      # HELP compliance_remediation_controls_manual Number of controls requiring manual remediation
      # TYPE compliance_remediation_controls_manual gauge
      compliance_remediation_controls_manual{vm_name="{{ inventory_hostname }}",namespace="{{ hostvars[inventory_hostname]['namespace'] | default('unknown') }}"} {{ manual_controls | default([]) | length }}

      # HELP compliance_remediation_last_timestamp Timestamp of last remediation
      # TYPE compliance_remediation_last_timestamp gauge
      compliance_remediation_last_timestamp{vm_name="{{ inventory_hostname }}",namespace="{{ hostvars[inventory_hostname]['namespace'] | default('unknown') }}"} {{ ansible_date_time.epoch }}
  when: not dry_run

- name: Push remediation metrics to Pushgateway
  when:
    - not dry_run
    - metrics_config.pushgateway_url | default('') | length > 0
  ansible.builtin.uri:
    url: "{{ metrics_config.pushgateway_url }}/metrics/job/compliance_remediation/instance/{{ inventory_hostname }}"
    method: POST
    body: "{{ remediation_metrics_payload }}"
    headers:
      Content-Type: text/plain
    status_code: [200, 202]
  delegate_to: localhost
  ignore_errors: true
