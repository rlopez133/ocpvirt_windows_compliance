---
# Remediate Role - Main Task Dispatcher
# Scan-driven CAT I remediation only
# Only fixes controls that failed in the scan results

- name: Validate remediation configuration
  ansible.builtin.assert:
    that:
      - failed_cat1_controls is defined
    fail_msg: "failed_cat1_controls must be provided from scan results"

- name: Display remediation plan
  ansible.builtin.debug:
    msg: |
      Scan-Driven CAT I Remediation
      =============================
      Profile: {{ compliance_profile }}
      Failed CAT I Controls: {{ failed_cat1_controls | length }}
      Controls: {{ failed_cat1_controls | join(', ') | default('None') }}
      Allow Reboot: {{ allow_reboot }}
      Dry Run: {{ dry_run }}
      Trigger: {{ trigger_source }}

- name: Gather Windows facts
  ansible.windows.win_powershell:
    script: |
      $os = Get-CimInstance Win32_OperatingSystem
      @{
        Caption = $os.Caption
        Version = $os.Version
        BuildNumber = $os.BuildNumber
      } | ConvertTo-Json -Compress
  register: os_info_raw

- name: Parse OS information
  ansible.builtin.set_fact:
    # win_powershell.output is a list, join it to get the JSON string
    os_info: "{{ (os_info_raw.output | join('')) | from_json }}"

- name: Determine Windows version
  ansible.builtin.set_fact:
    windows_version: >-
      {%- if '2022' in os_info.Caption -%}
        2022
      {%- elif '2019' in os_info.Caption -%}
        2019
      {%- else -%}
        unknown
      {%- endif -%}

- name: Display detected OS
  ansible.builtin.debug:
    msg: "Detected Windows Server {{ windows_version }} (Build {{ os_info.BuildNumber }})"

- name: Create system restore point
  when: remediation.create_restore_point | default(true) and not dry_run
  ansible.windows.win_powershell:
    script: |
      Checkpoint-Computer -Description "Pre-Compliance-Remediation-{{ ansible_date_time.iso8601 }}" -RestorePointType MODIFY_SETTINGS
  ignore_errors: true

- name: Log remediation start
  ansible.builtin.set_fact:
    remediation_start_time: "{{ ansible_date_time.iso8601 }}"

# ============================================================================
# Apply scan-driven remediation based on failed controls
# ============================================================================
- name: Apply Windows 2019 STIG scan-driven remediation
  when:
    - windows_version == '2019'
    - failed_cat1_controls | length > 0
  ansible.builtin.include_tasks:
    file: "{{ playbook_dir }}/../roles/win2019_stig/tasks/scan_driven_remediation.yml"
  vars:
    failed_cat1_controls: "{{ failed_cat1_controls }}"

- name: Skip remediation - no failed CAT I controls
  when: failed_cat1_controls | length == 0
  ansible.builtin.debug:
    msg: "No failed CAT I controls to remediate. System may already be compliant."

- name: Fail if OS not supported
  when: windows_version == 'unknown'
  ansible.builtin.fail:
    msg: "Unsupported Windows version: {{ os_info.Caption }}. Only Windows Server 2019 is currently supported."

- name: Fail if Windows 2022 (not yet implemented)
  when: windows_version == '2022'
  ansible.builtin.fail:
    msg: "Windows Server 2022 scan-driven remediation not yet implemented. Coming soon."

- name: Log remediation completion
  ansible.builtin.set_fact:
    remediation_result:
      started: "{{ remediation_start_time }}"
      completed: "{{ ansible_date_time.iso8601 }}"
      os_version: "{{ windows_version }}"
      profile: "{{ compliance_profile }}"
      trigger: "{{ trigger_source }}"
      dry_run: "{{ dry_run }}"
      failed_cat1_count: "{{ failed_cat1_controls | length }}"

- name: Display remediation summary
  ansible.builtin.debug:
    msg: |
      Remediation Complete
      ====================
      Started: {{ remediation_result.started }}
      Completed: {{ remediation_result.completed }}
      OS Version: Windows Server {{ remediation_result.os_version }}
      Profile: {{ remediation_result.profile }}
      Failed CAT I Controls Processed: {{ remediation_result.failed_cat1_count }}
      Dry Run: {{ remediation_result.dry_run }}

      Note: Run a compliance scan to verify remediation effectiveness.
