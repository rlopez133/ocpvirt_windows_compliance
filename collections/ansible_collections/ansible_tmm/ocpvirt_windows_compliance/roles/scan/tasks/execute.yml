---
# Scan Role - Execute Scan
# Simplified approach: All benchmarks are enabled by default in SCC
# Just run the scan and find the results

- name: Generate scan ID
  ansible.builtin.set_fact:
    scan_id: "scan-{{ ansible_date_time.epoch }}"
    scan_start_time: "{{ ansible_date_time.iso8601 }}"

- name: Set scan paths
  ansible.builtin.set_fact:
    scan_output_dir: "{{ scc_config.output_dir }}\\{{ scan_id }}"
    scc_exe: "{{ scc_install_path }}\\cscc.exe"
    scc_results_dir: "{{ ansible_env.USERPROFILE }}\\SCC\\Results"

- name: Display scan configuration
  ansible.builtin.debug:
    msg: |
      Starting SCC Scan
      - Scan ID: {{ scan_id }}
      - SCC Path: {{ scc_exe }}
      - Target Benchmark: {{ scc_benchmark }}
      - Output Dir: {{ scan_output_dir }}
      - SCC Results Dir: {{ scc_results_dir }}

- name: Create scan output directory
  ansible.windows.win_file:
    path: "{{ scan_output_dir }}"
    state: directory

# --- Run the scan ---
- name: Execute SCC scan
  ansible.windows.win_shell: |
    $sccPath = '{{ scc_exe }}'
    $outputDir = '{{ scan_output_dir }}'

    # Run SCC in quiet mode
    # It will scan all enabled benchmarks and output to default location
    $result = & $sccPath -q 2>&1
    $exitCode = $LASTEXITCODE

    # Save scan output for debugging
    $result | Out-File "$outputDir\scc_output.txt" -Force

    # Return exit code
    $exitCode
  register: scan_result
  async: "{{ scan_timeout }}"
  poll: 30

- name: Display scan result
  ansible.builtin.debug:
    msg: |
      SCC scan completed
      - Return code: {{ scan_result.rc }}
      - Stdout: {{ scan_result.stdout | default('') | trim }}
      - Stderr: {{ scan_result.stderr | default('') | trim }}

# --- Wait for results ---
- name: Wait for result files to be written
  ansible.builtin.pause:
    seconds: 5

# --- Find results in multiple locations ---
- name: List contents of SCC Results directory
  ansible.windows.win_shell: |
    $resultsDir = '{{ scc_results_dir }}'
    if (Test-Path $resultsDir) {
        Get-ChildItem -Path $resultsDir -Recurse |
            Select-Object FullName, Length, LastWriteTime |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 50 |
            ConvertTo-Json -Compress
    } else {
        '{"error": "Results directory does not exist"}'
    }
  register: scc_dir_contents
  changed_when: false

- name: Display SCC Results directory contents
  ansible.builtin.debug:
    msg: "SCC Results directory: {{ scc_dir_contents.stdout }}"

# --- Find XCCDF result file ---
- name: Find XCCDF result files
  ansible.windows.win_find:
    paths:
      - "{{ scc_results_dir }}"
      - "{{ ansible_env.USERPROFILE }}\\SCC"
      - "C:\\SCC\\Results"
    patterns:
      - "*XCCDF-Results*.xml"
      - "*xccdf*results*.xml"
    recurse: true
    age: "-10m"
  register: xccdf_files
  ignore_errors: true

- name: Display found XCCDF files
  ansible.builtin.debug:
    msg: "Found {{ xccdf_files.files | default([]) | length }} XCCDF files: {{ xccdf_files.files | default([]) | map(attribute='path') | list }}"

- name: Set XCCDF result path
  ansible.builtin.set_fact:
    xccdf_result_file: "{{ (xccdf_files.files | sort(attribute='lastwritetime', reverse=true) | first).path | default('') }}"
  when: xccdf_files.files | default([]) | length > 0

- name: Set empty XCCDF path if not found
  ansible.builtin.set_fact:
    xccdf_result_file: ""
  when: xccdf_files.files | default([]) | length == 0

# --- Find HTML report ---
- name: Find HTML report files
  ansible.windows.win_find:
    paths:
      - "{{ scc_results_dir }}"
      - "{{ ansible_env.USERPROFILE }}\\SCC"
    patterns:
      - "*Summary*.html"
      - "*Report*.html"
      - "*.html"
    recurse: true
    age: "-10m"
  register: html_files
  ignore_errors: true

- name: Set HTML report path
  ansible.builtin.set_fact:
    html_report_file: "{{ (html_files.files | sort(attribute='lastwritetime', reverse=true) | first).path | default('') }}"
  when: html_files.files | default([]) | length > 0

- name: Set empty HTML path if not found
  ansible.builtin.set_fact:
    html_report_file: ""
  when: html_files.files | default([]) | length == 0

# --- Copy results to output directory ---
- name: Copy XCCDF result to output directory
  ansible.windows.win_copy:
    src: "{{ xccdf_result_file }}"
    dest: "{{ scan_output_dir }}\\"
    remote_src: true
  when: xccdf_result_file | length > 0
  ignore_errors: true

- name: Copy HTML report to output directory
  ansible.windows.win_copy:
    src: "{{ html_report_file }}"
    dest: "{{ scan_output_dir }}\\"
    remote_src: true
  when: html_report_file | length > 0
  ignore_errors: true

# --- Build scan output object ---
- name: Build scan output object
  ansible.builtin.set_fact:
    scc_scan_output:
      scan_id: "{{ scan_id }}"
      output_dir: "{{ scan_output_dir }}"
      target_benchmark: "{{ scc_benchmark }}"
      started: "{{ scan_start_time }}"
      completed: "{{ ansible_date_time.iso8601 }}"
      exit_code: "{{ scan_result.rc }}"
      duration_seconds: "{{ scan_result.delta | regex_replace('^(\\d+):(\\d+):(\\d+).*', '\\1') | int * 3600 + scan_result.delta | regex_replace('^(\\d+):(\\d+):(\\d+).*', '\\2') | int * 60 + scan_result.delta | regex_replace('^(\\d+):(\\d+):(\\d+).*', '\\3') | int }}"
      xccdf_result: "{{ xccdf_result_file | default('') }}"
      html_report: "{{ html_report_file | default('') }}"
      scc_results_dir: "{{ scc_results_dir }}"

- name: Display scan execution result
  ansible.builtin.debug:
    msg: |
      Scan Execution Complete
      - Scan ID: {{ scc_scan_output.scan_id }}
      - Target Benchmark: {{ scc_scan_output.target_benchmark }}
      - Exit Code: {{ scc_scan_output.exit_code }}
      - XCCDF Result: {{ scc_scan_output.xccdf_result | default('Not found') }}
      - HTML Report: {{ scc_scan_output.html_report | default('Not found') }}
