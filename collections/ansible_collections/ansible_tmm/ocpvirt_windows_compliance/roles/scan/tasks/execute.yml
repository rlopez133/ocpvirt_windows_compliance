---
# Scan Role - Execute Scan
# Runs DISA SCC scan using correct CLI syntax

- name: Generate scan ID
  ansible.builtin.set_fact:
    scan_id: "scan-{{ ansible_date_time.epoch }}"

- name: Find STIG content path
  ansible.windows.win_find:
    paths: "{{ scc_install_path }}\\Resources\\Content"
    patterns: "{{ scc_benchmark }}*"
    file_type: directory
  register: stig_content_search

- name: Display found STIG content
  ansible.builtin.debug:
    msg: "STIG content directories: {{ stig_content_search.files | map(attribute='path') | list }}"

- name: Set STIG content path variable
  ansible.builtin.set_fact:
    stig_content_path: "{{ stig_content_search.files[0].path }}"
  when: stig_content_search.files | length > 0

- name: Find SCAP content file for benchmark
  ansible.windows.win_find:
    paths: "{{ stig_content_path }}"
    patterns: "*xccdf*.xml,*Benchmark*.xml"
    recurse: true
  register: scap_content_search
  when: stig_content_path is defined

- name: Display found SCAP content files
  ansible.builtin.debug:
    msg: "SCAP content files: {{ scap_content_search.files | default([]) | map(attribute='path') | list }}"
  when: scap_content_search is defined and scap_content_search is not skipped

- name: Set SCAP content file variable
  ansible.builtin.set_fact:
    scap_content_file: "{{ scap_content_search.files[0].path }}"
  when:
    - scap_content_search is defined
    - scap_content_search is not skipped
    - scap_content_search.files | length > 0

- name: Fail if no STIG content found
  ansible.builtin.fail:
    msg: |
      No STIG content found for benchmark '{{ scc_benchmark }}'.
      Searched in: {{ scc_install_path }}\\Resources\\Content
      Ensure STIG content was downloaded during SCC installation.
      Set scc_download_stig_content: true when running Install-SCC.
  when: scap_content_file is not defined

- name: Display scan configuration
  ansible.builtin.debug:
    msg: |
      Starting SCC Scan
      - Scan ID: {{ scan_id }}
      - SCC Path: {{ scc_install_path }}
      - SCAP Content: {{ scap_content_file }}
      - Output Dir: {{ scc_config.output_dir }}

- name: Copy STIG content to SCAP12_Content directory
  ansible.windows.win_copy:
    src: "{{ scap_content_file }}"
    dest: "{{ scc_install_path }}\\Resources\\Content\\SCAP12_Content\\"
    remote_src: true
  register: copy_stig_content
  ignore_errors: true

- name: Execute SCC scan
  ansible.windows.win_shell: |
    $scanId = "{{ scan_id }}"
    $outputDir = "{{ scc_config.output_dir }}\$scanId"
    $sccPath = "{{ scc_install_path }}\cscc.exe"
    $scapContentFile = "{{ scap_content_file }}"
    $scap12Dir = "{{ scc_install_path }}\Resources\Content\SCAP12_Content"

    # Create output directory
    New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

    $startTime = Get-Date
    $exitCode = 0
    $stdout = ""
    $stderr = ""

    try {
        # Get the benchmark filename (without extension for benchmark ID)
        $benchmarkFile = Split-Path $scapContentFile -Leaf
        $benchmarkId = [System.IO.Path]::GetFileNameWithoutExtension($benchmarkFile)

        # Step 1: List available benchmarks to find the correct ID
        $listArgs = @("--listBenchmarks")
        $listResult = & $sccPath @listArgs 2>&1
        $stdout = "AVAILABLE BENCHMARKS:`n" + ($listResult | Out-String) + "`n"

        # Step 2: Enable the Windows Server 2019 benchmark
        # Try to find a matching benchmark ID from the list
        $benchmarkLines = $listResult | Where-Object { $_ -match "Windows.*2019|2019.*STIG" }
        if ($benchmarkLines) {
            $stdout += "Found matching benchmarks: $benchmarkLines`n"
        }

        # Step 3: Run scan with quiet mode and output directory
        # SCC scans all enabled benchmarks
        $scanArgs = @("-q", "-u", $outputDir)
        $scanResult = & $sccPath @scanArgs 2>&1
        $stdout += "SCAN OUTPUT:`n" + ($scanResult | Out-String)
        $exitCode = $LASTEXITCODE
    } catch {
        $exitCode = 1
        $stderr = $_.Exception.Message
    }
    $endTime = Get-Date

    # Save output for debugging
    $stdout | Out-File "$outputDir\stdout.txt" -Force
    if ($stderr) { $stderr | Out-File "$outputDir\stderr.txt" -Force }

    # Find result files in output directory
    $xccdfFile = Get-ChildItem -Path $outputDir -Filter "*XCCDF-Results*.xml" -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if (-not $xccdfFile) {
        $xccdfFile = Get-ChildItem -Path $outputDir -Filter "*xccdf*.xml" -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    }
    # Also check SCC default location
    if (-not $xccdfFile) {
        $xccdfFile = Get-ChildItem -Path "$env:USERPROFILE\SCC\Results" -Filter "*XCCDF-Results*.xml" -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    }

    # Find HTML report
    $htmlFile = Get-ChildItem -Path $outputDir -Filter "*Summary*.html" -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if (-not $htmlFile) {
        $htmlFile = Get-ChildItem -Path $outputDir -Filter "*.html" -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    }

    # Return JSON result
    @{
        scan_id = $scanId
        output_dir = $outputDir
        started = $startTime.ToString("o")
        completed = $endTime.ToString("o")
        duration_seconds = [int]($endTime - $startTime).TotalSeconds
        exit_code = $exitCode
        scc_stdout = $stdout.Substring(0, [Math]::Min($stdout.Length, 2000))
        scc_stderr = $stderr
        xccdf_result = if ($xccdfFile) { $xccdfFile.FullName } else { $null }
        html_report = if ($htmlFile) { $htmlFile.FullName } else { $null }
    } | ConvertTo-Json -Compress
  register: scc_scan_raw
  async: "{{ scan_timeout }}"
  poll: 30

- name: Debug raw scan output
  ansible.builtin.debug:
    msg: |
      Raw scan result:
      - stdout length: {{ scc_scan_raw.stdout | default('') | length }}
      - stdout: {{ scc_scan_raw.stdout | default('EMPTY') }}
      - stderr: {{ scc_scan_raw.stderr | default('NONE') }}
      - rc: {{ scc_scan_raw.rc | default('N/A') }}

- name: Fail if scan produced no output
  ansible.builtin.fail:
    msg: |
      SCC scan produced no output.
      - Return code: {{ scc_scan_raw.rc | default('N/A') }}
      - Stderr: {{ scc_scan_raw.stderr | default('None') }}
  when: scc_scan_raw.stdout is not defined or scc_scan_raw.stdout | length == 0

- name: Parse scan output
  ansible.builtin.set_fact:
    scc_scan_output: "{{ scc_scan_raw.stdout | from_json }}"

- name: Display scan execution result
  ansible.builtin.debug:
    msg: |
      Scan Execution Complete
      - Scan ID: {{ scc_scan_output.scan_id }}
      - Duration: {{ scc_scan_output.duration_seconds }} seconds
      - Exit Code: {{ scc_scan_output.exit_code }}
      - XCCDF Result: {{ scc_scan_output.xccdf_result | default('Not found') }}
      - HTML Report: {{ scc_scan_output.html_report | default('Not found') }}
      - SCC Output: {{ scc_scan_output.scc_stdout | default('') | truncate(500) }}
