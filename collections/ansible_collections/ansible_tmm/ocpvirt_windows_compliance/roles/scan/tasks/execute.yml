---
# Scan Role - Execute Scan
# Configures SCC to enable only the target benchmark, then runs scan
# Refactored into discrete Ansible tasks for readability and maintainability

- name: Generate scan ID
  ansible.builtin.set_fact:
    scan_id: "scan-{{ ansible_date_time.epoch }}"
    scan_start_time: "{{ ansible_date_time.iso8601 }}"

- name: Set scan paths
  ansible.builtin.set_fact:
    scan_output_dir: "{{ scc_config.output_dir }}\\{{ scan_id }}"
    scc_exe: "{{ scc_install_path }}\\cscc.exe"
    scc_results_dir: "{{ ansible_env.USERPROFILE }}\\SCC\\Results"

- name: Display scan configuration
  ansible.builtin.debug:
    msg: |
      Starting SCC Scan
      - Scan ID: {{ scan_id }}
      - SCC Path: {{ scc_exe }}
      - Target Benchmark: {{ scc_benchmark }}
      - Output Dir: {{ scan_output_dir }}

- name: Create scan output directory
  ansible.windows.win_file:
    path: "{{ scan_output_dir }}"
    state: directory

# --- Step 1: List all benchmarks ---
- name: List all benchmarks
  ansible.windows.win_command: "{{ scc_exe }} --listAllBenchmarks"
  register: all_benchmarks_result
  changed_when: false

- name: Display all benchmarks
  ansible.builtin.debug:
    msg: "{{ all_benchmarks_result.stdout_lines }}"
    verbosity: 1

# --- Step 2: Parse enabled benchmarks ---
- name: Parse enabled benchmark names
  ansible.builtin.set_fact:
    enabled_benchmarks: >-
      {{
        all_benchmarks_result.stdout_lines
        | select('match', '^\s*Enabled\s+')
        | map('regex_replace', '^\s*Enabled\s+(.+?)\s+version:.*$', '\1')
        | list
      }}

- name: Display enabled benchmarks
  ansible.builtin.debug:
    msg: "Currently enabled benchmarks: {{ enabled_benchmarks }}"

# --- Step 3: Disable all enabled benchmarks ---
- name: Disable all enabled benchmarks
  ansible.windows.win_command: "{{ scc_exe }} --disableBenchmark \"{{ item }}\""
  loop: "{{ enabled_benchmarks }}"
  register: disable_results
  changed_when: true
  when: enabled_benchmarks | length > 0

- name: Display disable results
  ansible.builtin.debug:
    msg: "Disabled {{ enabled_benchmarks | length }} benchmarks"
  when: enabled_benchmarks | length > 0

# --- Step 4: Enable target benchmark ---
- name: Enable target benchmark
  ansible.windows.win_command: "{{ scc_exe }} --enableBenchmark \"{{ scc_benchmark }}\""
  register: enable_result

- name: Display enable result
  ansible.builtin.debug:
    msg: "Enable benchmark result: {{ enable_result.stdout | default('OK') }}"

# --- Step 5: Verify benchmark is enabled ---
- name: List enabled benchmarks for verification
  ansible.windows.win_command: "{{ scc_exe }} --listBenchmarks"
  register: enabled_check
  changed_when: false

- name: Check if target benchmark is enabled
  ansible.builtin.set_fact:
    benchmark_enabled: "{{ enabled_check.stdout is search(scc_benchmark) }}"

- name: Display enabled benchmarks after configuration
  ansible.builtin.debug:
    msg: |
      Enabled benchmarks:
      {{ enabled_check.stdout }}
      Target benchmark '{{ scc_benchmark }}' enabled: {{ benchmark_enabled }}

- name: Warn if benchmark not enabled
  ansible.builtin.debug:
    msg: "WARNING: Target benchmark '{{ scc_benchmark }}' may not be enabled. Scan may not produce expected results."
  when: not benchmark_enabled

# --- Step 6: Run the scan ---
- name: Execute SCC scan
  ansible.windows.win_command: "{{ scc_exe }} -q"
  register: scan_result
  async: "{{ scan_timeout }}"
  poll: 30

- name: Display scan command result
  ansible.builtin.debug:
    msg: |
      Scan completed
      - Return code: {{ scan_result.rc }}
      - Output: {{ scan_result.stdout | default('') | truncate(500) }}

# --- Step 7: Wait for result files ---
- name: Wait for result files to be written
  ansible.builtin.pause:
    seconds: 3

# --- Step 8: Find XCCDF result file ---
- name: Find XCCDF result files in SCC Results directory
  ansible.windows.win_find:
    paths: "{{ scc_results_dir }}"
    patterns: "*XCCDF-Results*.xml"
    recurse: true
    age: "-5m"
  register: xccdf_files

- name: Find any XML files if no XCCDF found
  ansible.windows.win_find:
    paths: "{{ scc_results_dir }}"
    patterns: "*.xml"
    recurse: true
    age: "-5m"
  register: xml_files
  when: xccdf_files.files | length == 0

- name: Set XCCDF result path
  ansible.builtin.set_fact:
    xccdf_result_file: >-
      {%- if xccdf_files.files | length > 0 -%}
        {{ (xccdf_files.files | sort(attribute='lastwritetime', reverse=true) | first).path }}
      {%- elif xml_files.files is defined and xml_files.files | length > 0 -%}
        {{ (xml_files.files | sort(attribute='lastwritetime', reverse=true) | first).path }}
      {%- else -%}
      {%- endif -%}

- name: Display found XCCDF file
  ansible.builtin.debug:
    msg: "XCCDF result file: {{ xccdf_result_file | default('Not found') }}"

# --- Step 9: Find HTML report ---
- name: Find HTML report files
  ansible.windows.win_find:
    paths: "{{ scc_results_dir }}"
    patterns: "*.html"
    recurse: true
    age: "-5m"
  register: html_files

- name: Set HTML report path
  ansible.builtin.set_fact:
    html_report_file: >-
      {%- if html_files.files | length > 0 -%}
        {{ (html_files.files | sort(attribute='lastwritetime', reverse=true) | first).path }}
      {%- else -%}
      {%- endif -%}

- name: Display found HTML file
  ansible.builtin.debug:
    msg: "HTML report file: {{ html_report_file | default('Not found') }}"

# --- Step 10: Copy results to output directory ---
- name: Copy XCCDF result to output directory
  ansible.windows.win_copy:
    src: "{{ xccdf_result_file }}"
    dest: "{{ scan_output_dir }}\\"
    remote_src: true
  when: xccdf_result_file | length > 0
  register: copy_xccdf

- name: Copy HTML report to output directory
  ansible.windows.win_copy:
    src: "{{ html_report_file }}"
    dest: "{{ scan_output_dir }}\\"
    remote_src: true
  when: html_report_file | length > 0
  register: copy_html

# --- Step 11: Build scan output object ---
- name: Build scan output object
  ansible.builtin.set_fact:
    scc_scan_output:
      scan_id: "{{ scan_id }}"
      output_dir: "{{ scan_output_dir }}"
      target_benchmark: "{{ scc_benchmark }}"
      started: "{{ scan_start_time }}"
      completed: "{{ ansible_date_time.iso8601 }}"
      duration_seconds: "{{ (ansible_date_time.epoch | int) - (scan_id | regex_replace('scan-', '') | int) }}"
      exit_code: "{{ scan_result.rc }}"
      xccdf_result: "{{ xccdf_result_file | default(None) }}"
      html_report: "{{ html_report_file | default(None) }}"
      scc_results_dir: "{{ scc_results_dir }}"
      benchmark_enabled: "{{ benchmark_enabled }}"

- name: Display scan execution result
  ansible.builtin.debug:
    msg: |
      Scan Execution Complete
      - Scan ID: {{ scc_scan_output.scan_id }}
      - Target Benchmark: {{ scc_scan_output.target_benchmark }}
      - Benchmark Enabled: {{ scc_scan_output.benchmark_enabled }}
      - Exit Code: {{ scc_scan_output.exit_code }}
      - XCCDF Result: {{ scc_scan_output.xccdf_result | default('Not found') }}
      - HTML Report: {{ scc_scan_output.html_report | default('Not found') }}
