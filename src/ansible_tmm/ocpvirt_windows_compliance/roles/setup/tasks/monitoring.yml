---
# Setup Role - User Workload Monitoring Configuration
# Enables OpenShift user workload monitoring for compliance metrics

- name: Check if user workload monitoring is enabled
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: cluster-monitoring-config
    namespace: openshift-monitoring
  register: cluster_monitoring_config

- name: Enable user workload monitoring
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cluster-monitoring-config
        namespace: openshift-monitoring
      data:
        config.yaml: |
          enableUserWorkload: true
  when: >-
    cluster_monitoring_config.resources | length == 0 or
    'enableUserWorkload: true' not in (cluster_monitoring_config.resources[0].data['config.yaml'] | default(''))

- name: Wait for user workload monitoring to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: prometheus-operator
    namespace: openshift-user-workload-monitoring
  register: uwm_operator
  until: >-
    uwm_operator.resources | length > 0 and
    (uwm_operator.resources[0].status.readyReplicas | default(0)) > 0
  retries: 30
  delay: 10

- name: Display user workload monitoring status
  ansible.builtin.debug:
    msg: "User workload monitoring is enabled and ready"
